<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§öÂÆùÈ™∞Â≠ê (Duo Bao Dice) - ÂÆåÁæé‰ΩìÈ™åÁâà</title>
    
    <!-- ÂºïÂÖ• React Âíå Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ÂêØÁî® JIT Ê®°Âºè -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    
    <!-- ÂºïÂÖ•ÂõæÊ†áÂ∫ì -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- È¢ÑËÆæÂ≠ó‰Ωì -->
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ÂÖ®Â±ÄÊ†∑ÂºèË∞ÉÊï¥ */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #0a1128;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #root { height: 100%; }
        .font-cute { font-family: 'Zcool KuaiLe', sans-serif; }

        /* --- 3D È™∞Â≠êÂºïÊìé --- */
        .scene {
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cube-wrapper {
            position: relative;
            transform-style: preserve-3d;
            width: 60px; /* Mobile Default */
            height: 60px;
            transition: transform 1.2s cubic-bezier(0.19, 1, 0.22, 1); 
        }
        @media (min-width: 640px) { .cube-wrapper { width: 80px; height: 80px; } }

        .cube {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
        }

        .face {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1), inset 0 0 2px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            backface-visibility: hidden;
        }
        @media (min-width: 640px) { 
            .face { width: 80px; height: 80px; border-radius: 16px; box-shadow: inset 0 0 15px rgba(0,0,0,0.1); } 
        }

        /* È™∞Â≠êÁÇπÊï∞ */
        .dot {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
        }
        .dot.red { background: #ff5e5e; box-shadow: inset 1px 1px 2px rgba(100,0,0,0.3); }
        @media (min-width: 640px) { .dot { width: 16px; height: 16px; } }

        /* 3DÊûÑÂª∫ */
        .cube-wrapper .face.front  { transform: rotateY(0deg) translateZ(30px); }
        .cube-wrapper .face.back   { transform: rotateY(180deg) translateZ(30px); }
        .cube-wrapper .face.right  { transform: rotateY(90deg) translateZ(30px); }
        .cube-wrapper .face.left   { transform: rotateY(-90deg) translateZ(30px); }
        .cube-wrapper .face.top    { transform: rotateX(90deg) translateZ(30px); }
        .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(30px); }
        
        @media (min-width: 640px) {
            .cube-wrapper .face.front  { transform: rotateY(0deg) translateZ(40px); }
            .cube-wrapper .face.back   { transform: rotateY(180deg) translateZ(40px); }
            .cube-wrapper .face.right  { transform: rotateY(90deg) translateZ(40px); }
            .cube-wrapper .face.left   { transform: rotateY(-90deg) translateZ(40px); }
            .cube-wrapper .face.top    { transform: rotateX(90deg) translateZ(40px); }
            .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(40px); }
        }

        /* Âä®ÊÄÅÈò¥ÂΩ± */
        .shadow-spot {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(rgba(0,0,0,0.4), transparent 70%);
            transform: rotateX(90deg) translateZ(-50px);
            filter: blur(8px);
            opacity: 0.6;
            transition: all 0.3s;
        }
        @media (min-width: 640px) { .shadow-spot { width: 80px; height: 80px; transform: translateZ(-65px); } }

        /* Ëµ¢Èí±È£òÂ≠óÂä®Áîª */
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
        }
        .floating-text {
            position: absolute;
            color: #fbbf24;
            font-weight: 900;
            font-family: 'Zcool KuaiLe', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            z-index: 50;
        }

        /* ËæìËµ¢Èó™ÁÉÅ */
        @keyframes flash-win {
            0%, 100% { border-color: rgba(234, 179, 8, 1); box-shadow: 0 0 0 transparent; }
            50% { border-color: #fff; box-shadow: 0 0 30px #fbbf24; }
        }
        .animate-win { animation: flash-win 0.8s infinite; }

        /* ÁéªÁíÉÁΩ©Ë¥®ÊÑü */
        .dome-glass {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.01) 50%, rgba(255,255,255,0.05) 100%);
            box-shadow: inset 0 0 20px rgba(255,255,255,0.1), 0 10px 20px rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .game-bg {
            background-color: #1a1c2c;
            background-image: radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 2px);
            background-size: 40px 40px;
        }
        .game-overlay { background: radial-gradient(circle at center, rgba(26, 28, 44, 0.4) 0%, rgba(10, 12, 20, 0.9) 100%); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeIn 0.3s ease-out forwards; }
    </style>

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, doc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp
        };
    </script>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Èü≥È¢ë & ÈúáÂä® ---
        const AudioSynth = {
            ctx: null,
            init: () => { if (!AudioSynth.ctx) AudioSynth.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: (freq, type, duration) => {
                AudioSynth.init();
                const osc = AudioSynth.ctx.createOscillator();
                const gain = AudioSynth.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(AudioSynth.ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, AudioSynth.ctx.currentTime + duration);
                osc.stop(AudioSynth.ctx.currentTime + duration);
            },
            playRoll: () => {
                for(let i=0; i<6; i++) setTimeout(() => AudioSynth.playTone(1200 + Math.random()*800, 'sine', 0.05), i * 60);
            },
            playWin: () => {
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'sine', 0.4), i * 100));
            },
            playLose: () => AudioSynth.playTone(200, 'triangle', 0.3),
            playChip: () => AudioSynth.playTone(1500, 'sine', 0.08),
            
            // ÈúáÂä®ÂèçÈ¶à API
            vibrate: (pattern) => {
                if (navigator.vibrate) navigator.vibrate(pattern);
            }
        };

        // --- Á≤íÂ≠êÊïàÊûú ---
        const ParticleSystem = ({ active }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const particles = [];
                const colors = ['#FCD34D', '#F59E0B', '#FFFFFF', '#60A5FA']; 
                for(let i=0; i<80; i++) particles.push({
                    x: window.innerWidth/2, y: window.innerHeight/2,
                    vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                    size: Math.random()*6+4, color: colors[Math.floor(Math.random()*colors.length)], life: 1.0
                });
                const animate = () => {
                    if (!canvas) return;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = false;
                    particles.forEach(p => {
                        if(p.life > 0) {
                            alive = true;
                            p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.vx *= 0.95; p.life -= 0.015;
                            ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                        }
                    });
                    if (alive) requestAnimationFrame(animate); else ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                animate();
            }, [active]);
            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-50" />;
        };

        // --- ËÅäÂ§©ÁªÑ‰ª∂ ---
        const ChatRoom = ({ user, db, appId, nickname, setNickname }) => {
            const [messages, setMessages] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const [inputText, setInputText] = useState("");
            const [isEditingName, setIsEditingName] = useState(!nickname);
            const [tempName, setTempName] = useState(nickname);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!user || !db) return;
                const q = window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setMessages(msgs.slice(-50));
                });
                return () => unsubscribe();
            }, [user, db, appId]);

            useEffect(() => { if(isOpen) messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);

            const saveNickname = () => {
                if(tempName.trim()) {
                    setNickname(tempName.trim());
                    setIsEditingName(false);
                    localStorage.setItem('dice_game_nickname', tempName.trim());
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputText.trim() || !user) return;
                const text = inputText.trim();
                setInputText("");
                try {
                    await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), {
                        text: text,
                        senderId: user.uid.slice(0, 5),
                        senderName: nickname || `User ${user.uid.slice(0,3)}`,
                        isSystem: false,
                        createdAt: window.FB.serverTimestamp()
                    });
                } catch (err) { console.error("Send failed", err); }
            };

            return (
                <div className={`fixed bottom-20 sm:bottom-4 right-4 z-50 flex flex-col items-end transition-all duration-300`}>
                    {isOpen && (
                        <div className="mb-3 w-72 sm:w-80 h-80 sm:h-96 glass-panel flex flex-col overflow-hidden border-0 shadow-2xl animate-fade-in-up bg-slate-900/95">
                            <div className="bg-indigo-600/80 p-2 sm:p-3 flex justify-between items-center">
                                <span className="text-white font-bold text-xs sm:text-sm flex items-center gap-2">
                                    <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                    Êë∏È±ºËÅäÂ§©ÂÆ§
                                </span>
                                <button onClick={() => setIsOpen(false)} className="text-white/70 hover:text-white px-2">‚úï</button>
                            </div>
                            {isEditingName ? (
                                <div className="absolute inset-0 z-20 bg-slate-900/95 flex flex-col items-center justify-center p-4">
                                    <h3 className="text-yellow-400 font-bold mb-4 text-sm">Ëµ∑‰∏™ÂêçÂ≠ó</h3>
                                    <input type="text" value={tempName} onChange={(e)=>setTempName(e.target.value)} placeholder="‰æãÂ¶Ç: ËµåÁ•ûÈòøÂº∫" className="w-full bg-white/10 border border-indigo-500 rounded-xl px-4 py-2 text-white mb-4 text-center focus:outline-none text-sm" />
                                    <button onClick={saveNickname} className="bg-indigo-500 text-white px-6 py-2 rounded-full font-bold text-sm">ÂºÄÂßã</button>
                                </div>
                            ) : (
                                <div className="bg-indigo-900/30 px-3 py-2 text-[10px] sm:text-xs text-indigo-200 flex justify-between cursor-pointer hover:bg-indigo-900/50 border-b border-white/5" onClick={()=>setIsEditingName(true)}>
                                    <span>ÂΩìÂâç: {nickname}</span><span>(ÊîπÂêç)</span>
                                </div>
                            )}
                            <div className="flex-1 overflow-y-auto p-2 sm:p-3 space-y-2 chat-scroll">
                                {messages.map((msg) => {
                                    const isMe = msg.senderId === user?.uid.slice(0, 5);
                                    const isSystem = msg.isSystem;
                                    if (isSystem) return (
                                        <div key={msg.id} className="flex justify-center my-2">
                                            <span className="bg-yellow-500/20 text-yellow-300 text-[10px] px-3 py-1 rounded-full border border-yellow-500/30 font-bold shadow-[0_0_10px_rgba(234,179,8,0.2)]">
                                                üì£ {msg.text}
                                            </span>
                                        </div>
                                    );
                                    return (
                                        <div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                            <span className="text-[10px] text-white/40 mb-0.5 px-1">{msg.senderName}</span>
                                            <div className={`max-w-[85%] px-3 py-1.5 rounded-2xl text-xs break-words ${isMe ? 'bg-indigo-500 text-white rounded-tr-none' : 'bg-slate-700 text-gray-200 rounded-tl-none'}`}>{msg.text}</div>
                                        </div>
                                    );
                                })}
                                <div ref={messagesEndRef} />
                            </div>
                            <form onSubmit={sendMessage} className="p-2 bg-slate-800/50 border-t border-white/5 flex gap-2">
                                <input type="text" value={inputText} onChange={(e)=>setInputText(e.target.value)} placeholder="ËØ¥ÁÇπ‰ªÄ‰πà..." disabled={isEditingName} className="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-3 py-1.5 text-xs text-white focus:outline-none focus:border-indigo-500" />
                                <button type="submit" disabled={isEditingName} className="bg-indigo-500 text-white p-1.5 rounded-full"><lucide-icon name="send" size="14"></lucide-icon></button>
                            </form>
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-indigo-500 text-white flex items-center justify-center hover:scale-110 transition-transform shadow-lg group border-2 border-white/20 overflow-hidden relative">
                        {isOpen ? <span className="text-xl font-bold">‚úï</span> : <img src="1.jpg" alt="Chat" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/724/724715.png'}} />}
                        {!isOpen && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-indigo-900 animate-bounce"></span>}
                    </button>
                </div>
            );
        };

        // --- Âçï‰∏™3DÈ™∞Â≠êÁªÑ‰ª∂ ---
        const Die3D = ({ value, rolling }) => {
            const [transform, setTransform] = useState('');
            useEffect(() => {
                if (rolling) {
                    const x = Math.random() * 1440 - 720; 
                    const y = Math.random() * 1440 - 720;
                    setTransform(`rotateX(${x}deg) rotateY(${y}deg)`);
                } else {
                    let rX = 0, rY = 0;
                    switch(value) {
                        case 1: rX = 0; rY = 0; break;
                        case 2: rX = 0; rY = 180; break; 
                        case 3: rX = 0; rY = -90; break;
                        case 4: rX = 0; rY = 90; break;
                        case 5: rX = -90; rY = 0; break;
                        case 6: rX = 90; rY = 0; break;
                    }
                    // ÈöèÊú∫‰∏ÄÁÇπÁÇπÂÅèÁßªÔºåËÆ©ÂÆÉÁúãËµ∑Êù•‰∏çÈÇ£‰πàÊ≠ªÊùø
                    const wobbleX = (Math.random() - 0.5) * 10;
                    const wobbleY = (Math.random() - 0.5) * 10;
                    setTransform(`rotateX(${rX + 1440 + wobbleX}deg) rotateY(${rY + 1440 + wobbleY}deg)`); 
                }
            }, [value, rolling]);

            const Face = ({ dots, className }) => (
                <div className={`face ${className}`}>
                    <div className="relative w-full h-full grid grid-cols-3 grid-rows-3 p-1 sm:p-1.5">
                        {dots.map((pos, i) => (
                            <div key={i} className={`dot ${pos.val === 'center' ? 'red' : ''}`} style={{ gridColumn: pos.col, gridRow: pos.row, alignSelf: 'center', justifySelf: 'center' }} />
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="scene mx-2 sm:mx-3">
                    <div className="cube-wrapper" style={{ transform: transform }}>
                        <div className="cube">
                            <Face className="front" dots={[{col:2,row:2,val:'center'}]} /> 
                            <Face className="back" dots={[{col:1,row:1},{col:3,row:3}]} /> 
                            <Face className="right" dots={[{col:1,row:1},{col:2,row:2},{col:3,row:3}]} /> 
                            <Face className="left" dots={[{col:1,row:1},{col:1,row:3},{col:3,row:1},{col:3,row:3}]} /> 
                            <Face className="top" dots={[{col:1,row:1},{col:3,row:1},{col:2,row:2},{col:1,row:3},{col:3,row:3}]} /> 
                            <Face className="bottom" dots={[{col:1,row:1},{col:1,row:2},{col:1,row:3},{col:3,row:1},{col:3,row:2},{col:3,row:3}]} /> 
                        </div>
                        <div className={`shadow-spot ${rolling ? 'scale-50' : 'scale-100'}`}></div>
                    </div>
                </div>
            );
        };

        const RoadMapDot = ({ result }) => {
            let color = 'bg-slate-500';
            let text = '?';
            if (result === 'big') { color = 'bg-red-500'; text = 'Â§ß'; }
            if (result === 'small') { color = 'bg-blue-500'; text = 'Â∞è'; }
            if (result === 'triple') { color = 'bg-green-500'; text = 'Ë±π'; }
            return <div className={`w-5 h-5 sm:w-6 sm:h-6 rounded-full ${color} flex items-center justify-center text-[10px] text-white font-bold shadow-sm border border-white/10`}>{text}</div>;
        };

        // --- ÊµÆÂä®ÊñáÂ≠óÁªÑ‰ª∂ ---
        const FloatingText = ({ text, x, y }) => {
            return (
                <div className="floating-text" style={{ left: x, top: y, fontSize: '24px' }}>
                    {text}
                </div>
            );
        };

        // --- ‰∏ªÁ®ãÂ∫è ---
        const App = () => {
            const [balance, setBalance] = useState(10000);
            const [bets, setBets] = useState({ small: 0, big: 0, triple: 0 });
            const [gameState, setGameState] = useState('idle');
            const [dice, setDice] = useState([1, 1, 1]);
            const [history, setHistory] = useState([]);
            const [showParticles, setShowParticles] = useState(false);
            const [selectedChip, setSelectedChip] = useState(100);
            const [nickname, setNickname] = useState('');
            const [winningZones, setWinningZones] = useState([]);
            const [floatingTexts, setFloatingTexts] = useState([]); // Ëµ¢Èí±È£òÂ≠óÁä∂ÊÄÅ
            
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            
            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appIdRef = useRef('default-app-id'); 

            useEffect(() => {
                const savedName = localStorage.getItem('dice_game_nickname');
                if (savedName) setNickname(savedName);
            }, []);

            // ÂàùÂßãÂåñ Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    // ËøôÈáåÁöÑÈÖçÁΩÆÂ∑≤ÁªèÊòØ‰Ω†Êèê‰æõÁöÑÈÖçÁΩÆ‰∫Ü
                    const config = {
                        apiKey: "AIzaSyCfoqSV5dI6-dzrvfx1e1NHnbpwlBTloKw",
                        authDomain: "haer-870de.firebaseapp.com",
                        projectId: "haer-870de",
                        storageBucket: "haer-870de.firebasestorage.app",
                        messagingSenderId: "397525543796",
                        appId: "1:397525543796:web:c503e7ebb1586335615a21",
                        measurementId: "G-08352H7R4G"
                    };

                    if (config && config.apiKey) {
                        try {
                            let app;
                            try { app = window.FB.initializeApp(config); } catch(e) { return; }
                            authRef.current = window.FB.getAuth(app);
                            dbRef.current = window.FB.getFirestore(app);
                            await window.FB.signInAnonymously(authRef.current);
                            window.FB.onAuthStateChanged(authRef.current, (u) => {
                                if (u) { setUser(u); setFirebaseReady(true); }
                            });
                        } catch (e) { console.error("Firebase Init Error:", e); }
                    }
                };
                setTimeout(initFirebase, 100);
            }, []);

            // ‰ΩôÈ¢ùÂêåÊ≠•ÈÄªËæë
            useEffect(() => {
                if (!user || !dbRef.current) return;
                const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account');
                const unsubscribe = window.FB.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.balance !== undefined) setBalance(data.balance);
                    } else {
                        window.FB.setDoc(docRef, { balance: 10000, createdAt: window.FB.serverTimestamp() }, { merge: true });
                        setBalance(10000);
                    }
                });
                return () => unsubscribe();
            }, [user]);

            const updateCloudBalance = async (newBalance) => {
                if (!user || !dbRef.current) return;
                try {
                    const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account');
                    await window.FB.updateDoc(docRef, { balance: newBalance });
                } catch(e) { console.error("Save failed", e); }
            };

            const placeBet = (type) => {
                if (gameState !== 'idle') return;
                if (balance < selectedChip) { alert("‰ΩôÈ¢ù‰∏çË∂≥Âï¶ÔºÅ"); return; }
                
                AudioSynth.playChip();
                AudioSynth.vibrate(20); // ËΩªÂæÆÈúáÂä®

                const newBalance = balance - selectedChip;
                setBalance(newBalance);
                updateCloudBalance(newBalance);
                setBets(prev => ({ ...prev, [type]: prev[type] + selectedChip }));
            };

            const rollDice = () => {
                if (bets.small === 0 && bets.big === 0 && bets.triple === 0) { alert("ËØ∑ÂÖà‰∏ãÊ≥®Âì¶ÔºÅ"); return; }
                
                setGameState('rolling');
                setWinningZones([]); 
                setFloatingTexts([]); // Ê∏ÖÈô§‰πãÂâçÁöÑÈ£òÂ≠ó
                
                AudioSynth.playRoll();
                AudioSynth.vibrate(100); // ÂºÄÂßãÊëáÂä®ÈúáÂä®
                
                setTimeout(() => {
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3;
                    const isTriple = (d1 === d2 && d2 === d3);
                    let mainResult = !isTriple ? (total >= 11 ? 'big' : 'small') : 'triple';
                    
                    setDice([d1, d2, d3]);
                    setTimeout(() => handleResult(d1, d2, d3, total, mainResult, isTriple), 1200); 
                }, 1500); 
            };

            const handleResult = (d1, d2, d3, total, mainResult, isTriple) => {
                setGameState('revealed');
                let totalWin = 0;
                const winners = [];
                const newFloatingTexts = [];

                // Ê£ÄÊü•ËæìËµ¢
                if (!isTriple && total >= 4 && total <= 10) {
                    if (bets.small > 0) {
                        const win = bets.small * 2;
                        totalWin += win;
                        // Ê∑ªÂä†È£òÂ≠ó: ÈöèÊú∫‰∏ÄÁÇπ‰ΩçÁΩÆÔºåÈÅøÂÖçÈáçÂè†
                        newFloatingTexts.push({ id: Date.now() + 's', text: `+$${win}`, x: '20%', y: '50%' });
                    }
                    winners.push('small');
                }
                if (!isTriple && total >= 11 && total <= 17) {
                    if (bets.big > 0) {
                        const win = bets.big * 2;
                        totalWin += win;
                        newFloatingTexts.push({ id: Date.now() + 'b', text: `+$${win}`, x: '70%', y: '50%' });
                    }
                    winners.push('big');
                }
                if (isTriple) {
                    if (bets.triple > 0) {
                        const win = bets.triple * 25;
                        totalWin += win;
                        newFloatingTexts.push({ id: Date.now() + 't', text: `+$${win}`, x: '45%', y: '40%' });
                    }
                    winners.push('triple');

                    // --- Ë±πÂ≠êÂÖ®ÊúçÈÄöÂëä ---
                    if (firebaseReady && user) {
                        window.FB.addDoc(window.FB.collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'chat_messages'), {
                            text: `ÊÅ≠Âñú ${nickname || 'Á•ûÁßò‰∫∫'} Êäº‰∏≠Ë±πÂ≠êÔºÅÂèëË¥¢Âï¶ÔºÅ`,
                            senderId: 'SYSTEM',
                            senderName: 'Á≥ªÁªü',
                            isSystem: true,
                            createdAt: window.FB.serverTimestamp()
                        });
                    }
                }

                setWinningZones(winners);

                if (totalWin > 0) {
                    const newBalance = balance + totalWin;
                    setBalance(newBalance);
                    updateCloudBalance(newBalance);
                    
                    AudioSynth.playWin();
                    AudioSynth.vibrate([100, 50, 100, 50, 200]); // Ëµ¢Èí±ËäÇÂ•èÈúáÂä®
                    setShowParticles(true);
                    setFloatingTexts(newFloatingTexts); // ÊòæÁ§∫È£òÂ≠ó

                    setTimeout(() => setShowParticles(false), 3000);
                } else {
                    AudioSynth.playLose();
                    AudioSynth.vibrate(300); // ËæìÈí±ÈïøÈúáÂä®
                }

                setHistory(prev => [...prev, { result: mainResult, total, dice: [d1, d2, d3] }].slice(-20)); 
                setTimeout(() => {
                    setGameState('idle');
                    setBets({ small: 0, big: 0, triple: 0 });
                    setWinningZones([]);
                    setFloatingTexts([]);
                }, 3500);
            };

            const chips = [100, 500, 1000];
            const totalBetAmount = bets.small + bets.big + bets.triple;

            return (
                <div className="relative w-full h-full flex flex-col items-center justify-between pb-4 game-bg overflow-hidden text-white">
                    <div className="absolute inset-0 game-overlay pointer-events-none"></div>
                    <ParticleSystem active={showParticles} />
                    
                    {/* Ëµ¢Èí±È£òÂ≠óÂ±Ç */}
                    <div className="absolute inset-0 pointer-events-none z-40">
                        {floatingTexts.map(ft => (
                            <FloatingText key={ft.id} text={ft.text} x={ft.x} y={ft.y} />
                        ))}
                    </div>
                    
                    {firebaseReady && (
                        <ChatRoom user={user} db={dbRef.current} appId={appIdRef.current} nickname={nickname} setNickname={setNickname} />
                    )}

                    {/* Header */}
                    <div className="z-10 w-full max-w-4xl p-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden border-2 border-white/20 shadow-lg bg-white">
                                <img src="1.jpg" alt="Avatar" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />
                            </div>
                            <div>
                                <h1 className="font-cute text-2xl sm:text-3xl text-yellow-300 tracking-wider drop-shadow-lg">Â§öÂÆùÈ™∞Â≠ê</h1>
                                <p className="text-indigo-200 text-[10px] sm:text-xs flex gap-1 items-center opacity-80">
                                    ID: <span className="font-mono bg-white/10 px-1 rounded">{user ? user.uid.slice(0,6) : '...'}</span>
                                    {nickname ? ` | ${nickname}` : ''}
                                </p>
                            </div>
                        </div>
                        <div className="glass-panel px-3 py-1.5 flex items-center gap-2">
                            <span className="text-yellow-400 text-lg">üí∞</span>
                            <span className="text-xl sm:text-2xl font-mono font-bold text-white">
                                {balance.toLocaleString()}
                            </span>
                        </div>
                    </div>

                    {/* Ê∏∏Êàè‰∏ªÂå∫Âüü - È™∞ÁõÖ */}
                    <div className="z-10 flex-1 flex flex-col justify-center items-center w-full -mt-10 sm:mt-0">
                        <div className="relative w-[85%] max-w-md h-40 sm:h-60 flex justify-center items-center bg-slate-900/40 rounded-[2.5rem] border border-white/10 shadow-2xl backdrop-blur-sm dome-glass">
                            {/* ÁªìÊûúÊèêÁ§∫ */}
                            {gameState === 'revealed' && (
                                <div className="absolute -top-14 sm:-top-16 animate-bounce z-30 w-full text-center">
                                    <span className={`font-cute text-4xl sm:text-5xl drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] stroke-2 ${winningZones.includes('big') ? 'text-red-400' : (winningZones.includes('small') ? 'text-blue-400' : 'text-green-400')}`}>
                                        {dice.reduce((a,b)=>a+b,0)}ÁÇπ! 
                                    </span>
                                    <div className="text-sm sm:text-base font-bold text-white/80 mt-1">
                                        {winningZones.includes('triple') ? 'ÂÖ®Âõ¥Ë±πÂ≠ê!' : (winningZones.includes('big') ? 'Â§ßËÉú!' : 'Â∞èËÉú!')}
                                    </div>
                                </div>
                            )}
                            <Die3D value={dice[0]} rolling={gameState === 'rolling'} />
                            <Die3D value={dice[1]} rolling={gameState === 'rolling'} />
                            <Die3D value={dice[2]} rolling={gameState === 'rolling'} />
                        </div>
                        {/* Áè†ÁõòË∑Ø */}
                        <div className="mt-5 h-6 flex gap-1 items-end opacity-90">
                            {history.map((h, idx) => <RoadMapDot key={idx} result={h.result} />)}
                        </div>
                    </div>

                    {/* Â∫ïÈÉ®Êìç‰ΩúÂå∫ */}
                    <div className="z-20 w-full max-w-4xl px-3 mb-2">
                        {/* ‰∏ãÊ≥®ÊåâÈíÆ */}
                        <div className="flex gap-2 sm:gap-4 mb-3 h-32 sm:h-40">
                            {/* Â∞è */}
                            <button disabled={gameState !== 'idle'} onClick={() => placeBet('small')} className={`flex-1 relative group rounded-2xl sm:rounded-3xl border-b-[6px] transition-all duration-100 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center gap-0.5 shadow-xl ${winningZones.includes('small') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''} ${bets.small > 0 ? 'bg-blue-600 border-blue-800' : 'bg-slate-700 border-slate-900'}`}>
                                <span className="font-cute text-5xl sm:text-6xl text-white drop-shadow-md">Â∞è</span>
                                <span className="text-white/60 text-[10px] sm:text-xs font-bold">4-10</span>
                                {bets.small > 0 && <div className="absolute -top-2 bg-yellow-400 text-black font-bold px-2 py-0.5 rounded-full shadow-md text-[10px] sm:text-xs">${bets.small}</div>}
                            </button>

                            {/* Ë±πÂ≠ê */}
                            <button disabled={gameState !== 'idle'} onClick={() => placeBet('triple')} className={`w-20 sm:w-28 relative group rounded-2xl sm:rounded-3xl border-b-[6px] transition-all duration-100 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center gap-0.5 shadow-xl ${winningZones.includes('triple') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''} ${bets.triple > 0 ? 'bg-green-600 border-green-800' : 'bg-slate-700 border-slate-900'}`}>
                                <span className="font-cute text-xl sm:text-3xl text-white drop-shadow-md block">Ë±πÂ≠ê</span>
                                <span className="text-[10px] text-white/60 font-bold block">1:24</span>
                                {bets.triple > 0 && <div className="absolute -top-2 bg-yellow-400 text-black font-bold px-2 py-0.5 rounded-full shadow-md text-[10px] sm:text-xs">${bets.triple}</div>}
                            </button>

                            {/* Â§ß */}
                            <button disabled={gameState !== 'idle'} onClick={() => placeBet('big')} className={`flex-1 relative group rounded-2xl sm:rounded-3xl border-b-[6px] transition-all duration-100 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center gap-0.5 shadow-xl ${winningZones.includes('big') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''} ${bets.big > 0 ? 'bg-red-600 border-red-800' : 'bg-slate-700 border-slate-900'}`}>
                                <span className="font-cute text-5xl sm:text-6xl text-white drop-shadow-md">Â§ß</span>
                                <span className="text-white/60 text-[10px] sm:text-xs font-bold">11-17</span>
                                {bets.big > 0 && <div className="absolute -top-2 bg-yellow-400 text-black font-bold px-2 py-0.5 rounded-full shadow-md text-[10px] sm:text-xs">${bets.big}</div>}
                            </button>
                        </div>

                        {/* ÊéßÂà∂Êù° */}
                        <div className="glass-panel rounded-xl p-2 flex justify-between items-center gap-3">
                            <div className="flex gap-2 pl-1">
                                {chips.map(val => (
                                    <button key={val} onClick={() => setSelectedChip(val)} className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full border-[3px] border-dashed flex items-center justify-center font-bold text-[10px] sm:text-xs shadow-md transition-transform active:scale-90 ${selectedChip === val ? 'border-yellow-400 bg-yellow-500 text-black -translate-y-1' : 'border-slate-500 bg-slate-700 text-slate-300'}`}>
                                        {val}
                                    </button>
                                ))}
                            </div>
                            <button onClick={rollDice} disabled={gameState === 'rolling' || totalBetAmount === 0} className={`flex-1 py-2.5 sm:py-3 rounded-lg font-cute text-xl sm:text-2xl tracking-widest shadow-lg transition-all active:scale-95 ${gameState === 'rolling' ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : (totalBetAmount > 0 ? 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover:shadow-yellow-500/50 animate-pulse-gold' : 'bg-slate-600 text-slate-400')}`}>
                                {gameState === 'rolling' ? 'Â•ΩËøêÊù•...' : 'ÂºÄ Êëá !'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>