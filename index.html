<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šå®éª°å­ (Duo Bao Dice) - ä¸æ»‘æš´å¯Œç‰ˆ</title>
    
    <!-- å¼•å…¥ React å’Œ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body, html {
            height: 100%; margin: 0; padding: 0; font-family: 'Roboto', sans-serif;
            background-color: #2a1b3d; overflow: hidden; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #root { height: 100%; }
        .font-cute { font-family: 'Zcool KuaiLe', sans-serif; }

        /* --- 3D éª°å­å¼•æ“ (é‡æ„ç‰ˆ) --- */
        .scene { perspective: 1200px; display: flex; justify-content: center; align-items: center; }
        
        .cube-wrapper { 
            position: relative; 
            transform-style: preserve-3d; 
            width: 60px; height: 60px; 
            /* é»˜è®¤æ— è¿‡æ¸¡ï¼Œç”±åŠ¨ç”»æ§åˆ¶ */
        }
        @media (min-width: 640px) { .cube-wrapper { width: 80px; height: 80px; } }

        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; }
        
        /* éª°å­æè´¨ä¼˜åŒ– - å‡å°‘é˜´å½±æ¨¡ç³ŠåŠå¾„ä»¥æå‡æ‰‹æœºæ€§èƒ½ */
        .face { position: absolute; width: 60px; height: 60px; background: linear-gradient(145deg, #fff5f7, #ffeef0); border-radius: 14px; box-shadow: inset 0 0 5px rgba(255,182,193,0.5); display: flex; justify-content: center; align-items: center; backface-visibility: hidden; }
        @media (min-width: 640px) { .face { width: 80px; height: 80px; border-radius: 18px; } }
        
        .dot { width: 12px; height: 12px; background: #ff9eb5; border-radius: 50%; box-shadow: inset 1px 1px 1px rgba(0,0,0,0.1); }
        .dot.red { background: #ff5e78; }
        @media (min-width: 640px) { .dot { width: 16px; height: 16px; } }
        
        /* 3Dæ„å»º */
        .cube-wrapper .face.front { transform: rotateY(0deg) translateZ(30px); }
        .cube-wrapper .face.back { transform: rotateY(180deg) translateZ(30px); }
        .cube-wrapper .face.right { transform: rotateY(90deg) translateZ(30px); }
        .cube-wrapper .face.left { transform: rotateY(-90deg) translateZ(30px); }
        .cube-wrapper .face.top { transform: rotateX(90deg) translateZ(30px); }
        .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(30px); }
        @media (min-width: 640px) {
            .cube-wrapper .face.front { transform: rotateY(0deg) translateZ(40px); }
            .cube-wrapper .face.back { transform: rotateY(180deg) translateZ(40px); }
            .cube-wrapper .face.right { transform: rotateY(90deg) translateZ(40px); }
            .cube-wrapper .face.left { transform: rotateY(-90deg) translateZ(40px); }
            .cube-wrapper .face.top { transform: rotateX(90deg) translateZ(40px); }
            .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(40px); }
        }

        /* é˜´å½± */
        .shadow-spot { position: absolute; width: 60px; height: 60px; background: radial-gradient(rgba(100,0,50,0.2), transparent 60%); transform: rotateX(90deg) translateZ(-50px); filter: blur(4px); opacity: 0.6; transition: all 0.3s; }
        @media (min-width: 640px) { .shadow-spot { width: 80px; height: 80px; transform: translateZ(-65px); } }

        /* --- å…³é”®åŠ¨ç”»ä¼˜åŒ– --- */
        /* æ— é™ç¿»æ»šåŠ¨ç”» - è§£å†³å¡é¡¿çš„æ ¸å¿ƒ */
        @keyframes tumble {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(360deg) rotateY(720deg) rotateZ(360deg); }
        }
        /* åˆ¹è½¦åŠ¨ç”» - å‡ºç»“æœæ—¶çš„ç¼“å†² */
        .settling { transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        
        /* èµ¢é’±é£˜å­— */
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.2); } }
        .floating-text { position: absolute; font-weight: 900; font-family: 'Zcool KuaiLe', sans-serif; text-shadow: 0 2px 0px #fff, 0 4px 4px rgba(0,0,0,0.2); pointer-events: none; animation: floatUp 2s ease-out forwards; z-index: 100; white-space: nowrap; }
        
        /* è·å®˜åŠ¨ç”» */
        @keyframes bounce-mascot { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes crazy-shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 50% { transform: translate(-1px, -2px) rotate(-2deg); } 100% { transform: translate(-1px, -1px) rotate(2deg); } }
        .mascot-idle { animation: bounce-mascot 3s infinite ease-in-out; }
        .mascot-rolling { animation: crazy-shake 0.1s infinite; }
        .mascot-win { animation: bounce-mascot 0.4s infinite ease-in-out; }

        .animate-win { animation: bounce-mascot 0.5s infinite; border-color: #fff !important; background-color: #ffbad2 !important; color: #881234 !important; transform: scale(1.05); z-index: 10; }

        /* æ ·å¼ */
        .cute-bg { background: linear-gradient(180deg, #41295a 0%, #2f0743 100%); }
        .cute-overlay { background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.3; }
        .glass-panel { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .speech-bubble { position: absolute; background: #fff; border-radius: 20px; padding: 4px 8px; font-size: 12px; color: #333; top: -30px; left: 50%; transform: translateX(-50%); white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s; pointer-events: none; font-weight: bold; }
        .show-bubble { opacity: 1; top: -35px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, doc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp };
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- éŸ³æ•ˆ ---
        const AudioSynth = {
            ctx: null,
            init: () => { if (!AudioSynth.ctx) AudioSynth.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: (freq, type, duration) => {
                AudioSynth.init(); const osc = AudioSynth.ctx.createOscillator(); const gain = AudioSynth.ctx.createGain();
                osc.type = type; osc.frequency.value = freq; osc.connect(gain); gain.connect(AudioSynth.ctx.destination);
                osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, AudioSynth.ctx.currentTime + duration); osc.stop(AudioSynth.ctx.currentTime + duration);
            },
            playRoll: () => { /* æ‘‡éª°å­æ—¶ç”±åŠ¨ç”»è§†è§‰ä¸»å¯¼ï¼Œå£°éŸ³è¾…åŠ© */ for(let i=0; i<5; i++) setTimeout(() => AudioSynth.playTone(800 + Math.random()*400, 'sine', 0.05), i * 80); },
            playWin: () => { [523, 659, 784, 1046, 1318].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'triangle', 0.2), i * 80)); },
            playJackpot: () => { 
                [1000, 1200, 1500, 2000, 2500, 3000, 2500, 3000].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'square', 0.15), i * 60)); 
            },
            playLose: () => { AudioSynth.playTone(200, 'sawtooth', 0.3); },
            playChip: () => AudioSynth.playTone(1800, 'sine', 0.05),
            playMeow: () => { 
                AudioSynth.init(); const osc = AudioSynth.ctx.createOscillator(); const gain = AudioSynth.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(900, AudioSynth.ctx.currentTime); osc.frequency.linearRampToValueAtTime(1300, AudioSynth.ctx.currentTime+0.15); osc.frequency.linearRampToValueAtTime(700, AudioSynth.ctx.currentTime+0.3);
                osc.connect(gain); gain.connect(AudioSynth.ctx.destination); osc.start(); gain.gain.exponentialRampToValueAtTime(0.001, AudioSynth.ctx.currentTime + 0.3); osc.stop(AudioSynth.ctx.currentTime + 0.3);
            },
            vibrate: (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); }
        };

        // --- çƒŸèŠ±ç²’å­ (æš´å¯Œç‰¹æ•ˆ) ---
        const FireworkSystem = ({ active }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                const particles = [];
                // é‡‘è‰²å’Œçº¢è‰²ç²’å­
                const colors = ['#FFD700', '#FFA500', '#FF4500', '#FFFFFF']; 
                
                // åˆ›å»ºçˆ†ç‚¸
                for(let i=0; i<150; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 15 + 5;
                    particles.push({
                        x: canvas.width / 2, y: canvas.height / 2,
                        vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: Math.random() * 5 + 2,
                        life: 1.0,
                        decay: Math.random() * 0.02 + 0.01
                    });
                }

                const animate = () => {
                    if (!canvas) return;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'lighter';
                    let alive = false;
                    particles.forEach(p => {
                        if(p.life > 0) {
                            alive = true;
                            p.x += p.vx; p.y += p.vy;
                            p.vx *= 0.95; p.vy *= 0.95; // é˜»åŠ›
                            p.vy += 0.2; // é‡åŠ›
                            p.life -= p.decay;
                            ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                        }
                    });
                    if (alive) requestAnimationFrame(animate); else ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                animate();
            }, [active]);
            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]" />;
        };

        // --- èŠå¤©å®¤ ---
        const ChatRoom = ({ user, db, appId, nickname, setNickname, balance }) => {
            const [messages, setMessages] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const [inputText, setInputText] = useState("");
            const [isEditingName, setIsEditingName] = useState(!nickname);
            const [tempName, setTempName] = useState(nickname);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!user || !db) return;
                const q = window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                    const msgs = []; snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setMessages(msgs.slice(-50));
                });
                return () => unsubscribe();
            }, [user, db, appId]);

            useEffect(() => { if(isOpen) messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);

            const saveNickname = () => { if(tempName.trim()) { setNickname(tempName.trim()); setIsEditingName(false); localStorage.setItem('dice_game_nickname', tempName.trim()); } };
            const sendMessage = async (textToSend) => {
                const msg = textToSend || inputText.trim();
                if (!msg || !user) return;
                if(!textToSend) setInputText("");
                try { await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), { text: msg, senderId: user.uid.slice(0, 5), senderName: nickname || `User ${user.uid.slice(0,3)}`, senderBalance: balance, isSystem: false, createdAt: window.FB.serverTimestamp() }); } catch (err) { }
            };
            const quickEmojis = ["(â‰§âˆ‡â‰¦)ï¾‰", "ğŸŸæ‘¸é±¼", "ğŸ’°å‘è´¢", "ğŸ˜­ç ´äº§", "ğŸ±å–µ", "ğŸš€666"];

            return (
                <div className={`fixed bottom-24 right-4 z-50 flex flex-col items-end`}>
                    {isOpen && (
                        <div className="mb-3 w-72 h-80 glass-panel flex flex-col overflow-hidden border-0 shadow-2xl animate-fade-in-up bg-slate-900/90">
                            <div className="bg-pink-500/90 p-2 flex justify-between items-center">
                                <span className="text-white font-bold text-xs">ğŸ’¬ å¿«ä¹é¢‘é“</span>
                                <button onClick={() => setIsOpen(false)} className="text-white/80 px-2">âœ•</button>
                            </div>
                            {isEditingName ? (
                                <div className="absolute inset-0 z-20 bg-slate-900/95 flex flex-col items-center justify-center p-4">
                                    <input type="text" value={tempName} onChange={(e)=>setTempName(e.target.value)} placeholder="æ˜µç§°" className="w-full bg-white/10 border border-pink-400 rounded-full px-4 py-2 text-white mb-4 text-center text-sm" />
                                    <button onClick={saveNickname} className="bg-pink-500 text-white px-6 py-2 rounded-full font-bold text-sm">ç¡®å®š</button>
                                </div>
                            ) : (
                                <div className="bg-pink-900/30 px-3 py-1 text-[10px] text-pink-100 flex justify-between cursor-pointer" onClick={()=>setIsEditingName(true)}><span>{nickname}</span><span>(ä¿®æ”¹)</span></div>
                            )}
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 chat-scroll">
                                {messages.map((msg) => {
                                    const isMe = msg.senderId === user?.uid.slice(0, 5);
                                    if (msg.isSystem) return (<div key={msg.id} className="flex justify-center"><span className="bg-yellow-500/20 text-yellow-200 text-[10px] px-2 py-0.5 rounded-full border border-yellow-500/30">ğŸ“£ {msg.text}</span></div>);
                                    return (<div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}><div className="flex items-center gap-1 mb-0.5 px-1"><span className="text-[10px] text-white/50">{msg.senderName}</span></div><div className={`max-w-[90%] px-3 py-1.5 rounded-2xl text-xs break-words ${isMe ? 'bg-pink-500 text-white rounded-tr-none' : 'bg-white/10 text-white rounded-tl-none'}`}>{msg.text}</div></div>);
                                })}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="px-2 py-1 flex gap-2 overflow-x-auto hide-scrollbar bg-white/5">{quickEmojis.map(e => <button key={e} onClick={()=>sendMessage(e)} className="flex-shrink-0 bg-white/10 hover:bg-white/20 px-2 py-1 rounded-full text-[10px] text-white">{e}</button>)}</div>
                            <form onSubmit={(e)=>{e.preventDefault(); sendMessage();}} className="p-2 bg-slate-800/50 border-t border-white/5 flex gap-2"><input type="text" value={inputText} onChange={(e)=>setInputText(e.target.value)} className="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-3 py-1.5 text-xs text-white" placeholder="..." /><button type="submit" disabled={isEditingName} className="bg-pink-500 text-white p-1.5 rounded-full"><lucide-icon name="send" size="14"></lucide-icon></button></form>
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className="w-12 h-12 rounded-full bg-pink-500 text-white flex items-center justify-center shadow-lg border-2 border-white/20 overflow-hidden relative animate-bounce">
                        {isOpen ? <span className="text-xl font-bold">âœ•</span> : <img src="1.jpg" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />}
                    </button>
                </div>
            );
        };

        // --- 3D éª°å­ (è§£å†³å¡é¡¿ç‰ˆ) ---
        const Die3D = ({ value, rolling }) => {
            const [style, setStyle] = useState({});
            const rollingAnim = useRef(null);

            useEffect(() => {
                if (rolling) {
                    // æ‘‡åŠ¨æ—¶ï¼šåº”ç”¨æ— é™æ—‹è½¬ CSS åŠ¨ç”»
                    setStyle({ animation: `tumble 0.6s linear infinite` });
                } else {
                    // åœæ­¢æ—¶ï¼šè®¡ç®—æœ€ç»ˆè§’åº¦ï¼Œå¹¶åº”ç”¨å¹³æ»‘è¿‡æ¸¡
                    let rX=0, rY=0;
                    switch(value) { case 1: rX=0; rY=0; break; case 2: rX=0; rY=180; break; case 3: rX=0; rY=-90; break; case 4: rX=0; rY=90; break; case 5: rX=-90; rY=0; break; case 6: rX=90; rY=0; break; }
                    
                    // ä¸ºäº†è§†è§‰è¿è´¯ï¼ŒåŠ ä¸Šå¤šåœˆæ—‹è½¬ (1080 = 3åœˆ)
                    const finalTransform = `rotateX(${rX + 1080}deg) rotateY(${rY + 1080}deg)`;
                    
                    setStyle({ 
                        animation: 'none', // åœæ­¢åŠ¨ç”»
                        transform: finalTransform,
                        transition: 'transform 0.5s cubic-bezier(0.1, 0.9, 0.2, 1)' // åˆ¹è½¦æ›²çº¿
                    });
                }
            }, [value, rolling]);

            const Face = ({ dots, className }) => (
                <div className={`face ${className}`}>
                    <div className="relative w-full h-full grid grid-cols-3 grid-rows-3 p-1">
                        {dots.map((pos, i) => (<div key={i} className={`dot ${pos.val === 'center' ? 'red' : ''}`} style={{ gridColumn: pos.col, gridRow: pos.row, alignSelf: 'center', justifySelf: 'center' }} />))}
                    </div>
                </div>
            );
            return (
                <div className="scene mx-2">
                    <div className="cube-wrapper" style={style}>
                        <div className="cube"><Face className="front" dots={[{col:2,row:2,val:'center'}]} /><Face className="back" dots={[{col:1,row:1},{col:3,row:3}]} /><Face className="right" dots={[{col:1,row:1},{col:2,row:2},{col:3,row:3}]} /><Face className="left" dots={[{col:1,row:1},{col:1,row:3},{col:3,row:1},{col:3,row:3}]} /><Face className="top" dots={[{col:1,row:1},{col:3,row:1},{col:2,row:2},{col:1,row:3},{col:3,row:3}]} /><Face className="bottom" dots={[{col:1,row:1},{col:1,row:2},{col:1,row:3},{col:3,row:1},{col:3,row:2},{col:3,row:3}]} /></div>
                        <div className={`shadow-spot ${rolling ? 'scale-50' : 'scale-100'}`}></div>
                    </div>
                </div>
            );
        };

        const FloatingText = ({ text, x, y, color }) => <div className="floating-text" style={{ left: x, top: y, fontSize: '24px', color: color || '#ffd700' }}>{text}</div>;

        const MascotDealer = ({ gameState }) => {
            const [msg, setMsg] = useState("");
            const [anim, setAnim] = useState("mascot-idle");
            useEffect(() => {
                if(gameState === 'rolling') { setAnim("mascot-rolling"); setMsg("æ‘‡æ‘‡æ‘‡!"); }
                else if(gameState === 'revealed') { setAnim("mascot-win"); setMsg("å¼€!"); setTimeout(()=>setMsg(""), 2000); }
                else { setAnim("mascot-idle"); }
            }, [gameState]);
            const poke = () => { AudioSynth.playMeow(); setAnim("mascot-win"); setMsg("å–µå‘œ~"); setTimeout(() => { setMsg(""); if(gameState==='idle') setAnim("mascot-idle"); }, 1500); };
            return (
                <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center cursor-pointer" onClick={poke}>
                    <div className={`relative w-20 h-20 sm:w-24 sm:h-24 ${anim}`}>
                        <img src="1.jpg" className="w-full h-full rounded-full border-4 border-white/50 shadow-lg object-cover bg-white" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />
                        <div className="absolute -top-2 left-0 w-6 h-6 bg-white/90 rounded-tl-xl rotate-[-10deg] -z-10"></div><div className="absolute -top-2 right-0 w-6 h-6 bg-white/90 rounded-tr-xl rotate-[10deg] -z-10"></div>
                    </div>
                    <div className={`speech-bubble ${msg ? 'show-bubble' : ''}`}>{msg}</div>
                </div>
            );
        };

        // --- æ¸¸æˆä¸»ä½“ ---
        const App = () => {
            const [balance, setBalance] = useState(10000);
            const [bets, setBets] = useState({ small: 0, big: 0, triple: 0 });
            const [pointBets, setPointBets] = useState({});
            const [specialBets, setSpecialBets] = useState({}); // s123, s456, t1, t2... t6
            const [gameState, setGameState] = useState('idle');
            const [dice, setDice] = useState([1, 1, 1]);
            const [history, setHistory] = useState([]);
            const [selectedChip, setSelectedChip] = useState(100);
            const [nickname, setNickname] = useState('');
            const [winningZones, setWinningZones] = useState([]);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [betHistory, setBetHistory] = useState([]); 
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [showRelief, setShowRelief] = useState(false);
            const [showFireworks, setShowFireworks] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appIdRef = useRef('default-app-id'); 

            useEffect(() => { const savedName = localStorage.getItem('dice_game_nickname'); if (savedName) setNickname(savedName); }, []);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    const config = { apiKey: "AIzaSyCfoqSV5dI6-dzrvfx1e1NHnbpwlBTloKw", authDomain: "haer-870de.firebaseapp.com", projectId: "haer-870de", storageBucket: "haer-870de.firebasestorage.app", messagingSenderId: "397525543796", appId: "1:397525543796:web:c503e7ebb1586335615a21", measurementId: "G-08352H7R4G" };
                    if (config && config.apiKey) {
                        try {
                            let app; try { app = window.FB.initializeApp(config); } catch(e) { return; }
                            authRef.current = window.FB.getAuth(app); dbRef.current = window.FB.getFirestore(app);
                            await window.FB.signInAnonymously(authRef.current);
                            window.FB.onAuthStateChanged(authRef.current, (u) => { if (u) { setUser(u); setFirebaseReady(true); } });
                        } catch (e) { console.error("Firebase Init Error:", e); }
                    }
                };
                setTimeout(initFirebase, 100);
            }, []);

            useEffect(() => {
                if (!user || !dbRef.current) return;
                const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account');
                const unsubscribe = window.FB.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data(); if (data.balance !== undefined) setBalance(data.balance);
                        const totalBets = Object.values(pointBets).reduce((a,b)=>a+b,0) + bets.small + bets.big + bets.triple + Object.values(specialBets).reduce((a,b)=>a+b,0);
                        if (data.balance < 100 && gameState === 'idle' && totalBets === 0) { setTimeout(() => setShowRelief(true), 1000); }
                    } else { window.FB.setDoc(docRef, { balance: 10000, createdAt: window.FB.serverTimestamp() }, { merge: true }); setBalance(10000); }
                });
                return () => unsubscribe();
            }, [user, gameState, pointBets, bets, specialBets]);

            const updateCloudBalance = async (newBalance) => {
                if (!user || !dbRef.current) return;
                try { const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account'); await window.FB.updateDoc(docRef, { balance: newBalance }); } catch(e) { }
            };

            const handleRelief = () => { AudioSynth.playWin(); const newBalance = balance + 2000; setBalance(newBalance); updateCloudBalance(newBalance); setShowRelief(false); };

            const addToBet = (category, key) => {
                if (gameState !== 'idle') return;
                if (balance < selectedChip) { AudioSynth.playLose(); return; }
                AudioSynth.playChip(); AudioSynth.vibrate(10);
                const newBalance = balance - selectedChip; setBalance(newBalance); updateCloudBalance(newBalance);
                setBetHistory(prev => [...prev, { category, key, amount: selectedChip }]);
                if (category === 'main') setBets(prev => ({ ...prev, [key]: prev[key] + selectedChip }));
                else if (category === 'point') setPointBets(prev => ({ ...prev, [key]: (prev[key] || 0) + selectedChip }));
                else if (category === 'special') setSpecialBets(prev => ({ ...prev, [key]: (prev[key] || 0) + selectedChip }));
            };

            const undoBet = () => {
                if (gameState !== 'idle' || betHistory.length === 0) return;
                const lastBet = betHistory[betHistory.length - 1];
                const newBalance = balance + lastBet.amount; setBalance(newBalance); updateCloudBalance(newBalance);
                if (lastBet.category === 'main') setBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                else if (lastBet.category === 'point') setPointBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                else if (lastBet.category === 'special') setSpecialBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                setBetHistory(prev => prev.slice(0, -1)); AudioSynth.playChip();
            };

            const rollDice = () => {
                if (betHistory.length === 0) { alert("è¯·å…ˆä¸‹æ³¨å–µï¼"); return; }
                setGameState('rolling'); setWinningZones([]); setFloatingTexts([]); setShowFireworks(false);
                AudioSynth.playRoll(); AudioSynth.vibrate([50, 50, 50]);
                setTimeout(() => {
                    const d1 = Math.floor(Math.random() * 6) + 1; const d2 = Math.floor(Math.random() * 6) + 1; const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3; const isTriple = (d1 === d2 && d2 === d3);
                    let mainResult = !isTriple ? (total >= 11 ? 'big' : 'small') : 'triple';
                    setDice([d1, d2, d3]);
                    setTimeout(() => handleResult(d1, d2, d3, total, mainResult, isTriple), 600); // è¿™é‡Œæ—¶é—´ç¼©çŸ­ï¼Œå› ä¸ºCSSåŠ¨ç”»ä¼šè‡ªåŠ¨åœ
                }, 1000); 
            };

            const handleResult = (d1, d2, d3, total, mainResult, isTriple) => {
                setGameState('revealed');
                let totalWin = 0; const winners = []; const newFloatingTexts = [];
                const diceStr = [d1, d2, d3].sort().join(''); 

                // 1. ä¸»ç©æ³•
                if (!isTriple && total >= 4 && total <= 10) { if (bets.small > 0) { const win = bets.small * 2; totalWin += win; newFloatingTexts.push({ id: 's', text: `+${win}`, x: '20%', y: '50%' }); } winners.push('small'); }
                if (!isTriple && total >= 11 && total <= 17) { if (bets.big > 0) { const win = bets.big * 2; totalWin += win; newFloatingTexts.push({ id: 'b', text: `+${win}`, x: '80%', y: '50%' }); } winners.push('big'); }
                if (isTriple) { if (bets.triple > 0) { const win = bets.triple * 25; totalWin += win; newFloatingTexts.push({ id: 't', text: `+${win}`, x: '50%', y: '40%' }); } winners.push('triple'); }

                // 2. ç‚¹æ•°ç©æ³•
                if (pointBets[total] > 0) { const win = pointBets[total] * 51; totalWin += win; winners.push(`p${total}`); newFloatingTexts.push({ id: 'p', text: `ğŸ¯ +${win}`, x: '50%', y: '30%', color: '#FF00FF' }); }

                // 3. ç‰¹æ®Šç©æ³• (500å€)
                if (diceStr === '123' && specialBets.s123 > 0) { const win = specialBets.s123 * 501; totalWin += win; winners.push('s123'); newFloatingTexts.push({ id: 'sp1', text: `ğŸš€æš´å¯Œ +${win}`, x: '50%', y: '50%', color: 'red' }); setShowFireworks(true); AudioSynth.playJackpot(); }
                if (diceStr === '456' && specialBets.s456 > 0) { const win = specialBets.s456 * 501; totalWin += win; winners.push('s456'); newFloatingTexts.push({ id: 'sp2', text: `ğŸš€æš´å¯Œ +${win}`, x: '50%', y: '50%', color: 'red' }); setShowFireworks(true); AudioSynth.playJackpot(); }
                
                // 4. ç‰¹å®šè±¹å­ (500å€) - 111, 222...
                if (isTriple) {
                    const key = `t${d1}`;
                    if (specialBets[key] > 0) {
                        const win = specialBets[key] * 501; totalWin += win; winners.push(key);
                        newFloatingTexts.push({ id: 'sp3', text: `ğŸ”¥è±¹å­ç‹ +${win}`, x: '50%', y: '60%', color: 'red' });
                        setShowFireworks(true); AudioSynth.playJackpot();
                    }
                }

                if (totalWin > 10000 && firebaseReady && user) { window.FB.addDoc(window.FB.collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'chat_messages'), { text: `ğŸ‰ ${nickname || 'æœ‰äºº'} ç‹‚èµš ${totalWin}ï¼å¤ªå¼ºäº†ï¼`, senderId: 'SYSTEM', senderName: 'ç³»ç»Ÿ', isSystem: true, createdAt: window.FB.serverTimestamp() }); }

                setWinningZones(winners);

                if (totalWin > 0) {
                    const newBalance = balance + totalWin; setBalance(newBalance); updateCloudBalance(newBalance);
                    if(!showFireworks) AudioSynth.playWin(); 
                    AudioSynth.vibrate([100, 50, 100]); setFloatingTexts(newFloatingTexts);
                } else { AudioSynth.playLose(); AudioSynth.vibrate(300); }

                setHistory(prev => [...prev, { result: mainResult, total, dice: [d1, d2, d3] }].slice(-10)); 
                setTimeout(() => { setGameState('idle'); setBets({ small: 0, big: 0, triple: 0 }); setPointBets({}); setSpecialBets({}); setBetHistory([]); setWinningZones([]); setFloatingTexts([]); setShowFireworks(false); }, 3500);
            };

            const chips = [100, 500, 1000, 5000];

            return (
                <div className="cute-bg text-white flex flex-col h-full w-full relative">
                    <div className="absolute inset-0 cute-overlay pointer-events-none"></div>
                    <FireworkSystem active={showFireworks} />
                    <div className="absolute inset-0 pointer-events-none z-40">{floatingTexts.map(ft => <FloatingText key={ft.id} text={ft.text} x={ft.x} y={ft.y} color={ft.color} />)}</div>
                    {firebaseReady && <ChatRoom user={user} db={dbRef.current} appId={appIdRef.current} nickname={nickname} setNickname={setNickname} balance={balance} />}
                    {showRelief && <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur flex items-center justify-center p-6 animate-fade-in-up"><div className="bg-white/10 border-2 border-pink-300 p-6 rounded-3xl text-center shadow-2xl w-full max-w-xs relative overflow-hidden"><div className="absolute inset-0 bg-pink-500/10"></div><div className="relative z-10"><div className="text-5xl mb-2">ğŸ˜¿</div><h3 className="text-2xl font-cute text-pink-200 mb-2">æ²¡é’±äº†...</h3><button onClick={handleRelief} className="bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold px-8 py-3 rounded-full shadow-lg animate-pulse-gold">é¢†å– $2,000 ç¿»æœ¬</button><button onClick={()=>setShowRelief(false)} className="block mt-4 text-xs text-white/40 underline w-full">å€”å¼ºç¦»å¼€</button></div></div></div>}

                    {/* Header */}
                    <div className="z-50 w-full max-w-4xl p-3 flex justify-between items-center relative flex-shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full overflow-hidden border-2 border-pink-300 shadow-lg bg-white flex-shrink-0"><img src="1.jpg" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} /></div>
                            <div className="min-w-0"><h1 className="font-cute text-xl text-pink-200 drop-shadow-sm">å¤šå®éª°å­</h1></div>
                        </div>
                        <div className="glass-panel px-3 py-1 flex items-center gap-2 flex-shrink-0 ml-2 border-pink-300/30"><span className="text-yellow-300 text-base">ğŸ’°</span><span className="text-lg font-mono font-bold text-white">{balance.toLocaleString()}</span></div>
                    </div>

                    {/* Scrollable Content */}
                    <div className="flex-1 overflow-y-auto w-full flex flex-col items-center pb-24 hide-scrollbar">
                        {/* Game Area */}
                        <div className="relative w-full flex justify-center items-center mt-8 mb-4 flex-shrink-0">
                            <div className="relative w-[85%] max-w-md h-36 flex justify-center items-center bg-white/5 rounded-[3rem] border border-pink-200/20 shadow-xl backdrop-blur-sm">
                                <MascotDealer gameState={gameState} />
                                {gameState === 'revealed' && <div className="absolute -top-12 animate-bounce z-30 w-full text-center pointer-events-none"><span className="font-cute text-5xl text-yellow-300 drop-shadow-lg stroke-2">{dice.reduce((a,b)=>a+b,0)}</span><span className="text-lg font-bold text-white ml-2">ç‚¹!</span></div>}
                                <Die3D value={dice[0]} rolling={gameState === 'rolling'} />
                                <Die3D value={dice[1]} rolling={gameState === 'rolling'} />
                                <Die3D value={dice[2]} rolling={gameState === 'rolling'} />
                            </div>
                        </div>
                        <div className="flex gap-1 h-5 opacity-70 mb-4">{history.map((h, i) => <div key={i} className={`w-5 h-5 rounded-full flex items-center justify-center text-[10px] text-white font-bold shadow-sm ${h.result==='big'?'bg-red-400':h.result==='small'?'bg-blue-400':'bg-green-400'}`}>{h.result==='big'?'å¤§':h.result==='small'?'å°':'è±¹'}</div>)}</div>

                        {/* Betting Area */}
                        <div className="w-full max-w-4xl px-3 flex flex-col gap-4">
                            
                            {/* Specific Triples (500x) */}
                            <div>
                                <div className="flex justify-between px-1 mb-1 text-[10px] text-pink-200/70"><span>ğŸ”¥ æš´å¯ŒåŒº (1èµ”500)</span><span>æ»‘åŠ¨ä¸‹æ³¨</span></div>
                                <div className="flex overflow-x-auto space-x-2 pb-2 hide-scrollbar px-1">
                                    <button disabled={gameState !== 'idle'} onClick={() => addToBet('special', 's123')} className={`flex-shrink-0 w-16 h-10 rounded-lg border bg-purple-900/50 border-purple-500/30 flex items-center justify-center relative ${winningZones.includes('s123')?'animate-win':''}`}>
                                        <span className="font-bold text-xs">123</span>
                                        {specialBets.s123>0 && <div className="absolute -top-2 right-0 bg-yellow-400 text-black text-[8px] px-1 rounded-full">${specialBets.s123}</div>}
                                    </button>
                                    <button disabled={gameState !== 'idle'} onClick={() => addToBet('special', 's456')} className={`flex-shrink-0 w-16 h-10 rounded-lg border bg-purple-900/50 border-purple-500/30 flex items-center justify-center relative ${winningZones.includes('s456')?'animate-win':''}`}>
                                        <span className="font-bold text-xs">456</span>
                                        {specialBets.s456>0 && <div className="absolute -top-2 right-0 bg-yellow-400 text-black text-[8px] px-1 rounded-full">${specialBets.s456}</div>}
                                    </button>
                                    {/* 111 to 666 */}
                                    {[1,2,3,4,5,6].map(n => (
                                        <button key={n} disabled={gameState !== 'idle'} onClick={() => addToBet('special', `t${n}`)} className={`flex-shrink-0 w-12 h-10 rounded-lg border bg-purple-900/50 border-purple-500/30 flex items-center justify-center relative ${winningZones.includes(`t${n}`)?'animate-win':''}`}>
                                            <div className="flex flex-col leading-none items-center">
                                                <span className="font-bold text-xs">{n}{n}{n}</span>
                                            </div>
                                            {specialBets[`t${n}`]>0 && <div className="absolute -top-2 right-0 bg-yellow-400 text-black text-[8px] px-1 rounded-full">${specialBets[`t${n}`]}</div>}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Point Bets (50x) */}
                            <div>
                                <div className="flex justify-between px-1 mb-1 text-[10px] text-pink-200/70"><span>ğŸ¯ çŒœç‚¹æ•° (1èµ”50)</span><span>æ»‘åŠ¨ä¸‹æ³¨</span></div>
                                <div className="flex overflow-x-auto space-x-2 pb-2 hide-scrollbar px-1">
                                    {Array.from({length: 14}, (_, i) => i + 4).map(num => (
                                        <button key={num} disabled={gameState !== 'idle'} onClick={() => addToBet('point', num)} className={`flex-shrink-0 w-12 h-14 rounded-2xl border-b-4 transition-all active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative ${pointBets[num] > 0 ? 'bg-pink-500 border-pink-700 text-white' : 'bg-white/10 border-white/10 text-pink-100/70 hover:bg-white/20'} ${winningZones.includes(`p${num}`) ? 'animate-win' : ''}`}>
                                            <span className="font-cute text-xl">{num}</span>
                                            {pointBets[num] > 0 && <span className="text-[8px] bg-black/20 px-1 rounded-full absolute bottom-1">${pointBets[num]}</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Main Bets */}
                            <div className="flex gap-3 h-24 mb-2">
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'small')} className={`flex-1 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.small>0?'bg-blue-400 border-blue-600':'bg-indigo-900/40 border-indigo-900/60'} ${winningZones.includes('small')?'animate-win':''}`}>
                                    <span className="font-cute text-4xl text-white drop-shadow-md">å°</span><span className="text-[10px] text-white/50">4-10</span>{bets.small>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.small}</div>}
                                </button>
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'triple')} className={`w-20 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.triple>0?'bg-green-400 border-green-600':'bg-indigo-900/40 border-indigo-900/60'} ${winningZones.includes('triple')?'animate-win':''}`}>
                                    <span className="font-cute text-xl text-white drop-shadow-md">è±¹å­</span><span className="text-[10px] text-white/50">1:24</span>{bets.triple>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.triple}</div>}
                                </button>
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'big')} className={`flex-1 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.big>0?'bg-red-400 border-red-600':'bg-indigo-900/40 border-indigo-900/60'} ${winningZones.includes('big')?'animate-win':''}`}>
                                    <span className="font-cute text-4xl text-white drop-shadow-md">å¤§</span><span className="text-[10px] text-white/50">11-17</span>{bets.big>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.big}</div>}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Fixed Footer Controls */}
                    <div className="absolute bottom-0 left-0 w-full p-3 bg-slate-900/90 border-t border-white/10 backdrop-blur-md z-30">
                        <div className="w-full max-w-4xl mx-auto flex justify-between items-center gap-3">
                            <button onClick={undoBet} disabled={gameState !== 'idle' || betHistory.length === 0} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 text-white/70 disabled:opacity-30 active:bg-white/20">
                                <lucide-icon name="rotate-ccw" size="18"></lucide-icon>
                            </button>
                            <div className="flex gap-2 flex-1 overflow-x-auto hide-scrollbar px-1">
                                {chips.map(val => <button key={val} onClick={() => setSelectedChip(val)} className={`flex-shrink-0 w-10 h-10 rounded-full border-2 border-dashed flex items-center justify-center font-bold text-[10px] transition-transform active:scale-90 ${selectedChip===val?'border-yellow-400 bg-yellow-500 text-black shadow-lg':'border-white/20 text-white/50'}`}>{val}</button>)}
                            </div>
                            <button onClick={rollDice} disabled={gameState === 'rolling' || betHistory.length === 0} className={`flex-1 py-2.5 rounded-xl font-cute text-xl tracking-widest shadow-lg active:scale-95 transition-all ${gameState==='rolling'?'bg-slate-600 text-white/50 cursor-not-allowed':'bg-gradient-to-r from-pink-500 to-purple-500 text-white animate-pulse-gold'}`}>
                                {gameState === 'rolling' ? '...' : 'å¼€ æ‘‡'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>