<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šå®éª°å­ (Duo Bao Dice) - æˆ˜ç»©é£äº‘ç‰ˆ</title>
    
    <!-- åŸç‰ˆ CDN (Google/Unpkg) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body, html {
            height: 100%; margin: 0; padding: 0; font-family: 'Roboto', sans-serif;
            background-color: #0f172a; 
            overflow-x: hidden; touch-action: pan-y; overscroll-behavior: none;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #root { height: 100dvh; display: flex; flex-direction: column; }
        .font-cute { font-family: 'Zcool KuaiLe', sans-serif; }

        /* --- åˆå¤œèµ›åšä¸»é¢˜ --- */
        .theme-bg { 
            background: radial-gradient(circle at 50% 0%, #2e1065 0%, #020617 100%); 
        }
        .theme-overlay {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
        }

        /* ç»ç’ƒé¢æ¿ */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }

        /* éª°å­å®¹å™¨ - å…è®¸æº¢å‡ºæ˜¾ç¤ºè·å®˜ */
        .game-container {
            position: relative;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.15);
            border-radius: 40px;
            overflow: visible !important; 
            z-index: 10; 
        }

        /* --- 3D éª°å­ --- */
        .scene { perspective: 1200px; display: flex; justify-content: center; align-items: center; }
        .cube-wrapper { position: relative; transform-style: preserve-3d; width: 60px; height: 60px; }
        @media (min-width: 640px) { .cube-wrapper { width: 80px; height: 80px; } }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; }
        
        /* éª°å­æè´¨ - èµ›åšç™½ */
        .face { 
            position: absolute; width: 60px; height: 60px; 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0); 
            border-radius: 12px; 
            box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.5); 
            display: flex; justify-content: center; align-items: center; backface-visibility: hidden; 
        }
        @media (min-width: 640px) { .face { width: 80px; height: 80px; border-radius: 16px; } }
        
        .dot { width: 12px; height: 12px; background: #1e293b; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        .dot.red { background: #ef4444; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); }
        @media (min-width: 640px) { .dot { width: 16px; height: 16px; } }
        
        .cube.golden .face { background: linear-gradient(135deg, #f59e0b, #fbbf24); border: 2px solid #fff; box-shadow: 0 0 20px #fbbf24; }
        .cube.golden .dot { background: #fff; }

        .cube-wrapper .face.front { transform: rotateY(0deg) translateZ(30px); }
        .cube-wrapper .face.back { transform: rotateY(180deg) translateZ(30px); }
        .cube-wrapper .face.right { transform: rotateY(90deg) translateZ(30px); }
        .cube-wrapper .face.left { transform: rotateY(-90deg) translateZ(30px); }
        .cube-wrapper .face.top { transform: rotateX(90deg) translateZ(30px); }
        .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(30px); }
        @media (min-width: 640px) {
            .cube-wrapper .face.front { transform: rotateY(0deg) translateZ(40px); }
            .cube-wrapper .face.back { transform: rotateY(180deg) translateZ(40px); }
            .cube-wrapper .face.right { transform: rotateY(90deg) translateZ(40px); }
            .cube-wrapper .face.left { transform: rotateY(-90deg) translateZ(40px); }
            .cube-wrapper .face.top { transform: rotateX(90deg) translateZ(40px); }
            .cube-wrapper .face.bottom { transform: rotateX(-90deg) translateZ(40px); }
        }

        .shadow-spot { position: absolute; width: 60px; height: 60px; background: radial-gradient(rgba(0,0,0,0.5), transparent 60%); transform: rotateX(90deg) translateZ(-50px); filter: blur(6px); opacity: 0.7; transition: all 0.3s; }
        @media (min-width: 640px) { .shadow-spot { width: 80px; height: 80px; transform: translateZ(-65px); } }

        @keyframes tumble { 0% { transform: rotateX(0) rotateY(0) rotateZ(0); } 100% { transform: rotateX(360deg) rotateY(720deg) rotateZ(360deg); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.3); } }
        .floating-text { position: absolute; font-weight: 900; font-family: 'Zcool KuaiLe', sans-serif; text-shadow: 0 2px 0px #000; pointer-events: none; animation: floatUp 1.5s ease-out forwards; z-index: 100; white-space: nowrap; }
        
        @keyframes bounce-mascot { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes heart-beat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .mascot-idle { animation: bounce-mascot 3s infinite ease-in-out; }
        .mascot-rolling { animation: bounce-mascot 0.2s infinite; }
        .mascot-win { animation: bounce-mascot 0.5s infinite; }
        .mascot-love { animation: heart-beat 0.5s infinite; }
        .mascot-super { animation: heart-beat 0.3s infinite; box-shadow: 0 0 30px #fbbf24; border-color: #fbbf24 !important; }

        .animate-win { animation: bounce-mascot 0.5s infinite; border-color: #fcd34d !important; background-color: rgba(251, 191, 36, 0.2) !important; color: #fbbf24 !important; transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chat-scroll::-webkit-scrollbar { width: 0px; } 
        
        .speech-bubble { 
            position: absolute; background: #fff; border-radius: 12px; padding: 6px 12px; 
            font-size: 12px; color: #0f172a; top: -40px; left: 50%; transform: translateX(-50%); 
            white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            opacity: 0; transition: opacity 0.3s, transform 0.3s; 
            pointer-events: none; font-weight: bold; z-index: 30;
            border: 2px solid #8b5cf6;
        }
        .speech-bubble::after { 
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); 
            border-width: 6px 6px 0; border-style: solid; border-color: #8b5cf6 transparent transparent transparent; 
        }
        .show-bubble { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        
        .result-tag {
            display: inline-block;
            background: linear-gradient(to right, #fbbf24, #d97706);
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: bounce-mascot 1s infinite;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* æˆ˜ç»©æ¦œæ ·å¼ */
        .leader-item:nth-child(1) .rank-num { color: #fbbf24; text-shadow: 0 0 8px #fbbf24; }
        .leader-item:nth-child(2) .rank-num { color: #e2e8f0; text-shadow: 0 0 8px #e2e8f0; }
        .leader-item:nth-child(3) .rank-num { color: #f97316; text-shadow: 0 0 8px #f97316; }
        .positive-score { color: #4ade80; text-shadow: 0 0 5px rgba(74, 222, 128, 0.3); }
        .negative-score { color: #f87171; }

        /* å¤´è¡”å¾½ç« ç‰¹æ•ˆ */
        @keyframes shine-gold { 0% { background-position: -100px; } 100% { background-position: 200px; } }
        .badge-shine {
            position: relative; overflow: hidden;
        }
        .badge-shine::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: shine-gold 3s infinite linear;
        }
        
        /* è¶…çº§æŠ•å–‚ç‰¹æ•ˆ - é›¨è½ */
        @keyframes rain-fall { 
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } 
        }
        .rain-item { position: absolute; animation: rain-fall linear forwards; top: -50px; z-index: 90; }
        
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pulse-gold { animation: pulseGold 2s infinite; }
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }

    </style>

    <!-- åŸç‰ˆ Firebase Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // æŒ‚è½½åˆ° window ä¾› Babel Script ä½¿ç”¨
        window.FB = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            updateDoc, 
            addDoc, 
            onSnapshot, 
            serverTimestamp, 
            runTransaction,
            getDoc 
        };
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å¤´è¡”ç³»ç»Ÿé€»è¾‘ ---
        const getRankConfig = (balance) => {
            const bal = balance || 0;
            if (bal >= 200000) return { title: 'ğŸ‰ å¤šå®è‡³å°Š', color: 'bg-gradient-to-r from-gray-900 to-yellow-600 border-yellow-400 text-yellow-200 badge-shine shadow-[0_0_10px_#ca8a04]' };
            if (bal >= 100000) return { title: 'ğŸ‘‘ å¤šå®éœ¸ä¸»', color: 'bg-gradient-to-r from-red-600 to-pink-600 border-pink-300 text-white badge-shine' };
            if (bal >= 80000) return { title: 'ğŸ† å®è—å®ˆæŠ¤è€…', color: 'bg-purple-600 border-purple-400 text-white' };
            if (bal >= 60000) return { title: 'ğŸ¥‡ å¤šå®å¤§äº¨', color: 'bg-yellow-600 border-yellow-400 text-white' };
            if (bal >= 40000) return { title: 'ğŸ¥ˆ å¤ºå®å¥‡å…µ', color: 'bg-slate-400 border-slate-200 text-slate-900' };
            if (bal >= 20000) return { title: 'ğŸ¥‰ å¤šå®æ–°ç§€', color: 'bg-orange-700 border-orange-500 text-orange-100' };
            return { title: 'ğŸ£ å¯»å®å­¦å¾’', color: 'bg-slate-700 border-slate-500 text-slate-300' };
        };

        // --- éŸ³æ•ˆ ---
        const AudioSynth = {
            ctx: null,
            init: () => { if (!AudioSynth.ctx) AudioSynth.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: (freq, type, duration) => {
                AudioSynth.init(); const osc = AudioSynth.ctx.createOscillator(); const gain = AudioSynth.ctx.createGain();
                osc.type = type; osc.frequency.value = freq; osc.connect(gain); gain.connect(AudioSynth.ctx.destination);
                osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, AudioSynth.ctx.currentTime + duration); osc.stop(AudioSynth.ctx.currentTime + duration);
            },
            playRoll: () => { for(let i=0; i<5; i++) setTimeout(() => AudioSynth.playTone(800 + Math.random()*400, 'sine', 0.05), i * 80); },
            playWin: () => { [523, 659, 784, 1046, 1318].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'triangle', 0.2), i * 80)); },
            playJackpot: () => { [1000, 1200, 1500, 2000, 2500].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'square', 0.15), i * 60)); },
            playLose: () => { AudioSynth.playTone(200, 'sawtooth', 0.3); },
            playChip: () => AudioSynth.playTone(1800, 'sine', 0.05),
            playMeow: () => { 
                AudioSynth.init(); const osc = AudioSynth.ctx.createOscillator(); const gain = AudioSynth.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(900, AudioSynth.ctx.currentTime); osc.frequency.linearRampToValueAtTime(1300, AudioSynth.ctx.currentTime+0.15); osc.frequency.linearRampToValueAtTime(700, AudioSynth.ctx.currentTime+0.3);
                osc.connect(gain); gain.connect(AudioSynth.ctx.destination); osc.start(); gain.gain.exponentialRampToValueAtTime(0.001, AudioSynth.ctx.currentTime + 0.3); osc.stop(AudioSynth.ctx.currentTime + 0.3);
            },
            playKiss: () => {
                AudioSynth.init(); const osc = AudioSynth.ctx.createOscillator(); const gain = AudioSynth.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, AudioSynth.ctx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(600, AudioSynth.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, AudioSynth.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, AudioSynth.ctx.currentTime + 0.1);
                osc.connect(gain); gain.connect(AudioSynth.ctx.destination); osc.start(); osc.stop(AudioSynth.ctx.currentTime + 0.1);
            },
            vibrate: (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); }
        };

        // --- èŠå¤©å®¤ ---
        const ChatRoom = ({ user, db, appId, nickname, setNickname, balance }) => {
            const [messages, setMessages] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const [inputText, setInputText] = useState("");
            const [isEditingName, setIsEditingName] = useState(!nickname);
            const [tempName, setTempName] = useState(nickname);
            const [avatar, setAvatar] = useState(() => localStorage.getItem('dice_game_avatar') || 'ğŸ±');
            const [tempAvatar, setTempAvatar] = useState(() => localStorage.getItem('dice_game_avatar') || 'ğŸ±');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!user || !db) return;

                const q = window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                    const msgs = []; 
                    snapshot.forEach((doc) => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setMessages(msgs.slice(-50));
                });
                return () => unsubscribe();
            }, [user, db, appId]);

            useEffect(() => {
                if (!isOpen) return;

                const el = messagesEndRef.current;
                if (!el) return;
                // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨ DOM æ›´æ–°åå†æ»šåŠ¨ï¼Œé¿å…ç§»åŠ¨ç«¯æœ‰æ—¶ä¸ç”Ÿæ•ˆ
                setTimeout(() => {
                    el.scrollIntoView({ behavior: "smooth", block: "end" });
                }, 0);
            }, [messages, isOpen]);

            const formatTime = (timestamp) => {
                if (!timestamp || !timestamp.seconds) return '';
                const date = new Date(timestamp.seconds * 1000);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const saveNickname = () => { 
                if(tempName.trim()) { 
                    setNickname(tempName.trim()); 
                    localStorage.setItem('dice_game_nickname', tempName.trim()); 
                }
                if (tempAvatar.trim()) {
                    setAvatar(tempAvatar.trim());
                    localStorage.setItem('dice_game_avatar', tempAvatar.trim());
                }
                setIsEditingName(false); 
            };

            const sendMessage = async (textToSend) => {
                const msg = textToSend || inputText.trim();
                
                if (!user) {
                    alert("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...è¯·ç¨åå†è¯•ã€‚");
                    return;
                }
                if (!msg) return;

                // Optimistic clear (ç«‹åˆ»æ¸…ç©º)
                if(!textToSend) setInputText("");

                const displayName = `${avatar || ''} ${nickname || `User ${user.uid.slice(0,3)}`}`.trim();
                try { 
                    await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), { 
                        text: msg, 
                        senderId: user.uid.slice(0, 5), 
                        senderName: displayName, 
                        senderBalance: balance, 
                        isSystem: false, 
                        createdAt: window.FB.serverTimestamp() 
                    }); 
                } catch (err) { 
                    console.error(err);
                    alert("å‘é€å¤±è´¥: " + err.message + "\nå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€‚");
                }
            };

            const quickEmojis = ["(â‰§âˆ‡â‰¦)ï¾‰", "ğŸ€å¥½è¿", "ğŸ’°å‘è´¢", "ğŸ˜­è¾“å…‰", "ğŸ±å–µ", "ğŸš€èµ·é£"];

            return (
                <div className={`fixed bottom-28 right-4 z-[90] flex flex-col items-end`}>
                    {isOpen && (
                        <div className="mb-2 w-72 h-80 glass-panel flex flex-col overflow-hidden border border-indigo-500/30 shadow-2xl animate-fade-in-up bg-slate-900/95">
                            <div className="bg-indigo-600/90 p-2 flex justify-between items-center">
                                <span className="text-white font-bold text-xs">ğŸ’¬ ä¿±ä¹éƒ¨çƒ­èŠ</span>
                                <button onClick={() => setIsOpen(false)} className="text-white/80 px-2">âœ•</button>
                            </div>
                            {isEditingName ? (
                                <div className="absolute inset-0 z-20 bg-slate-900/95 flex flex-col items-center justify-center p-4 space-y-3">
                                    <input type="text" value={tempName} onChange={(e)=>setTempName(e.target.value)} placeholder="è¯·è¾“å…¥æ˜µç§°" className="w-full bg-white/10 border border-indigo-400 rounded-full px-4 py-2 text-white text-center text-sm" />
                                    <input type="text" value={tempAvatar} onChange={(e)=>setTempAvatar(e.target.value)} placeholder="å¤´åƒ emojiï¼Œå¦‚ ğŸ±" className="w-full bg-white/10 border border-indigo-400 rounded-full px-4 py-2 text-white text-center text-sm" />
                                    <div className="flex gap-2 text-xl">
                                        {['ğŸ±','ğŸ¯','ğŸ¶','ğŸ¼','ğŸ»','ğŸµ'].map(em => (
                                            <button key={em} type="button" onClick={()=>setTempAvatar(em)} className={`w-8 h-8 flex items-center justify-center rounded-full ${tempAvatar===em?'bg-indigo-500':'bg-white/10'}`}>{em}</button>
                                        ))}
                                    </div>
                                    <button onClick={saveNickname} className="mt-1 bg-indigo-500 text-white px-6 py-2 rounded-full font-bold text-sm">è¿›å…¥</button>
                                </div>
                            ) : (
                                <div className="bg-indigo-900/30 px-3 py-1 text-[10px] text-indigo-200 flex justify-between items-center cursor-pointer border-b border-white/5" onClick={()=>setIsEditingName(true)}>
                                    <span className="flex items-center gap-1">
                                        <span>{avatar}</span>
                                        <span>{nickname}</span>
                                    </span>
                                    <span>(ä¿®æ”¹)</span>
                                </div>
                            )}

                            <div className="flex-1 overflow-y-auto p-2 space-y-2 chat-scroll">
                                {messages.map((msg) => {
                                    const isMe = msg.senderId === user?.uid.slice(0, 5);
                                    const rank = getRankConfig(msg.senderBalance);

                                    if (msg.isSystem) return (<div key={msg.id} className="flex justify-center"><span className="bg-yellow-500/20 text-yellow-200 text-[10px] px-2 py-0.5 rounded-full border border-yellow-500/30">ğŸ“£ {msg.text}</span></div>);
                                    return (
                                        <div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                            <div className="flex items-center gap-1 mb-0.5 px-1">
                                                <span className={`text-[9px] px-1 rounded border ${rank.color} scale-90 origin-left`}>{rank.title}</span>
                                                <span className="text-[10px] text-white/70">{msg.senderName}</span>
                                                <span className="text-[9px] text-white/30 ml-1">{formatTime(msg.createdAt)}</span>
                                            </div>

                                            <div className={`max-w-[90%] px-3 py-1.5 rounded-xl text-xs break-words ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white/10 text-white rounded-tl-none'}`}>
                                                {msg.text}
                                                {msg.senderBalance !== undefined && <div className={`text-[8px] mt-1 text-right font-bold ${isMe ? 'text-yellow-200' : 'text-yellow-400'}`}>ğŸ’°{msg.senderBalance.toLocaleString()}</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="px-2 py-1 flex gap-2 overflow-x-auto hide-scrollbar bg-white/5">{quickEmojis.map(e => <button key={e} onClick={()=>sendMessage(e)} className="flex-shrink-0 bg-white/10 hover:bg-white/20 px-2 py-1 rounded-full text-[10px] text-white">{e}</button>)}</div>
                            <form onSubmit={(e)=>{e.preventDefault(); sendMessage();}} className="p-2 bg-slate-800/50 border-t border-white/5 flex gap-2">
                                <input type="text" value={inputText} onChange={(e)=>setInputText(e.target.value)} disabled={!user} className="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-3 py-1.5 text-xs text-white" placeholder={user ? "è¯´ç‚¹ä»€ä¹ˆ..." : "è¿æ¥ä¸­..."} />
                                <button type="submit" disabled={isEditingName || !user} className={`text-white p-1.5 rounded-full flex items-center justify-center w-8 h-8 ${!user ? 'bg-slate-600' : 'bg-indigo-500'}`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </form>
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg border-2 border-indigo-400 overflow-hidden relative active:scale-90 transition-transform">
                        {isOpen ? <span className="text-xl font-bold">âœ•</span> : <img src="1.jpg" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/724/724715.png'}} />}
                    </button>
                </div>
            );
        };

        // --- è¶…çº§æŠ•å–‚ç‰¹æ•ˆ ---
        const SuperFeedEffect = () => {
            const drops = Array.from({length: 30}).map((_,i) => ({
                left: Math.random() * 100 + '%',
                delay: Math.random() * 2 + 's',
                duration: Math.random() * 1.5 + 1.5 + 's',
                icon: Math.random() > 0.6 ? 'ğŸŸ' : (Math.random()>0.5 ? 'ğŸ’–' : 'ğŸ’°'),
                size: Math.random() * 1.5 + 1 + 'rem'
            }));
            
            return (
                <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
                    <div className="absolute inset-0 bg-yellow-500/20 animate-pulse"></div>
                    {drops.map((d, i) => (
                        <div key={i} className="rain-item" style={{left: d.left, animationDelay: d.delay, animationDuration: d.duration, fontSize: d.size}}>
                            {d.icon}
                        </div>
                    ))}
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center animate-bounce">
                        <div className="text-6xl mb-2">ğŸ˜»</div>
                        <div className="text-4xl font-cute text-yellow-300 drop-shadow-[0_0_10px_red] whitespace-nowrap bg-black/50 px-4 py-2 rounded-xl border-2 border-yellow-400">
                            çŒ«ç¥é™ä¸´ï¼è´¢æºå¹¿è¿›ï¼
                        </div>
                    </div>
                </div>
            )
        };

        // --- 3D éª°å­ ---
        const Die3D = ({ value, rolling, isGolden }) => {
            const [style, setStyle] = useState({});
            useEffect(() => {
                if (rolling) {
                    setStyle({ animation: `tumble 0.6s linear infinite` });
                } else {
                    let rX=0, rY=0;
                    switch(value) { case 1: rX=0; rY=0; break; case 2: rX=0; rY=180; break; case 3: rX=0; rY=-90; break; case 4: rX=0; rY=90; break; case 5: rX=-90; rY=0; break; case 6: rX=90; rY=0; break; }
                    setStyle({ 
                        animation: 'none', 
                        transform: `rotateX(${rX + 1080}deg) rotateY(${rY + 1080}deg)`,
                        transition: 'transform 0.5s cubic-bezier(0.1, 0.9, 0.2, 1)' 
                    });
                }
            }, [value, rolling]);

            const Face = ({ dots, className }) => (
                <div className={`face ${className}`}>
                    <div className="relative w-full h-full grid grid-cols-3 grid-rows-3 p-1">
                        {dots.map((pos, i) => (<div key={i} className={`dot ${pos.val === 'center' ? 'red' : ''}`} style={{ gridColumn: pos.col, gridRow: pos.row, alignSelf: 'center', justifySelf: 'center' }} />))}
                    </div>
                </div>
            );
            return (
                <div className="scene mx-2">
                    <div className="cube-wrapper" style={style}>
                        <div className={`cube ${isGolden ? 'golden' : ''}`}><Face className="front" dots={[{col:2,row:2,val:'center'}]} /><Face className="back" dots={[{col:1,row:1},{col:3,row:3}]} /><Face className="right" dots={[{col:1,row:1},{col:2,row:2},{col:3,row:3}]} /><Face className="left" dots={[{col:1,row:1},{col:1,row:3},{col:3,row:1},{col:3,row:3}]} /><Face className="top" dots={[{col:1,row:1},{col:3,row:1},{col:2,row:2},{col:1,row:3},{col:3,row:3}]} /><Face className="bottom" dots={[{col:1,row:1},{col:1,row:2},{col:1,row:3},{col:3,row:1},{col:3,row:2},{col:3,row:3}]} /></div>
                        <div className={`shadow-spot ${rolling ? 'scale-50' : 'scale-100'}`}></div>
                    </div>
                </div>
            );
        };

        const FloatingText = ({ text, x, y, color }) => <div className="floating-text" style={{ left: x, top: y, fontSize: '24px', color: color || '#fbbf24' }}>{text}</div>;

        // --- è·å®˜ (Fix: å…è®¸å›¾ç‰‡è¶…å‡ºå®¹å™¨) ---
        const MascotDealer = ({ gameState, onFeed, feedAnim, feedCount, showSuperFeed }) => {

            const [msg, setMsg] = useState("");
            const [anim, setAnim] = useState("mascot-idle");
            useEffect(() => {
                if (showSuperFeed) { setAnim("mascot-super"); setMsg("å–µå–µå–µï¼çˆ†ç±³å•¦ï¼"); return; }
                if (feedAnim) { setAnim("mascot-love"); setMsg("è€æ¿å¤§æ°”! çˆ±ä½ å–µ~"); return; }

                if(gameState === 'rolling') { setAnim("mascot-rolling"); setMsg("ç¥ä½ å¥½è¿!"); }
                else if(gameState === 'revealed') { setAnim("mascot-win"); setTimeout(()=>setMsg(""), 2000); }
                else { setAnim("mascot-idle"); }
            }, [gameState, feedAnim, showSuperFeed]);
            
            const poke = () => { AudioSynth.playMeow(); setAnim("mascot-win"); setMsg("å–µå‘œ~"); setTimeout(() => { setMsg(""); if(gameState==='idle') setAnim("mascot-idle"); }, 1500); };
            
            return (
                <div className="absolute -top-14 left-1/2 transform -translate-x-1/2 z-[60] flex flex-col items-center cursor-pointer">
                    <div className="relative" onClick={poke}>
                        <div className={`relative w-24 h-24 ${anim}`}>
                            <img src="1.jpg" className="w-full h-full rounded-full border-4 border-indigo-400 shadow-lg object-cover bg-white" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />
                        </div>
                        {/* æŠ•å–‚æŒ‰é’® */}
                        <button onClick={onFeed} className="absolute -bottom-2 -right-2 w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center border-2 border-white shadow-lg active:scale-90 transition-transform z-10 overflow-visible">
                            <span className="text-xl">ğŸŸ</span>
                            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[9px] font-bold w-5 h-5 flex items-center justify-center rounded-full border border-white shadow-sm">{feedCount}/10</span>
                        </button>
                    </div>
                    <div className={`speech-bubble ${msg ? 'show-bubble' : ''}`}>{msg}</div>
                </div>
            );
        };

        // --- æˆ˜ç»©æ’è¡Œæ¦œç»„ä»¶ (æ˜¾ç¤ºä»Šæ—¥ç›ˆäº) ---
        const StatsBoard = ({ db, appId }) => {
            const [leaders, setLeaders] = useState([]);

            useEffect(() => {
                if (!db) return;
                const q = window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        // å¦‚æœæ²¡æœ‰ profit å­—æ®µï¼Œæš‚æ—¶ç”¨ 0 (æ—§æ•°æ®å…¼å®¹)
                        if (p.profit !== undefined) {
                            data.push(p);
                        }
                    });
                    // æŒ‰ç›ˆåˆ©ä»é«˜åˆ°ä½æ’åº
                    data.sort((a, b) => b.profit - a.profit);
                    setLeaders(data.slice(0, 20)); // åªæ˜¾ç¤ºå‰20å
                });
                return () => unsubscribe();
            }, [db, appId]);

            return (
                <div className="w-full max-w-4xl px-4 mt-8 mb-40">
                    <div className="glass-panel p-4 border-indigo-500/30">
                        <h3 className="text-yellow-400 font-cute text-lg mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                            ä»Šæ—¥æˆ˜ç»©æ¦œ (Today's Profit)
                        </h3>
                        <div className="space-y-2">
                            {leaders.length === 0 && <div className="text-white/30 text-sm text-center py-4">æš‚æ— æˆ˜ç»©ï¼Œå¿«æ¥æŠ¢å æ¦œé¦–ï¼</div>}
                            {leaders.map((player, index) => {
                                const rank = getRankConfig(player.balance);
                                return (
                                <div key={index} className="leader-item flex justify-between items-center bg-slate-800/60 p-3 rounded-lg border border-white/5">
                                    <div className="flex items-center gap-3">
                                        <span className={`rank-num font-bold w-6 text-center ${index===0?'text-yellow-400':index===1?'text-gray-300':index===2?'text-orange-400':'text-white/40'}`}>
                                            {index + 1}
                                        </span>
                                        <div className="w-8 h-8 rounded-full bg-indigo-900 overflow-hidden border border-white/10">
                                            <img src="1.jpg" className="w-full h-full object-cover opacity-80" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-xs text-indigo-100">{player.nickname || 'ç¥ç§˜äºº'}</span>
                                            <span className={`text-[9px] px-1 rounded border self-start ${rank.color}`}>{rank.title}</span>
                                        </div>
                                    </div>
                                    <span className={`font-mono text-sm font-bold ${player.profit >= 0 ? 'positive-score' : 'negative-score'}`}>
                                        {player.profit >= 0 ? '+' : ''}{player.profit?.toLocaleString()}
                                    </span>
                                </div>
                            )})}
                        </div>
                    </div>
                </div>
            );
        };

        // --- æ¯æ—¥ä½ä¿å¼¹çª— ---
        const DailyBonusModal = ({ amount, onClose }) => (
            <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur flex items-center justify-center p-6 animate-fade-in-up">
                <div className="bg-indigo-900 border-2 border-yellow-400 p-6 rounded-3xl text-center shadow-[0_0_50px_rgba(234,179,8,0.5)] w-full max-w-xs relative overflow-hidden">
                    <div className="text-6xl mb-4">ğŸ</div>
                    <h3 className="text-2xl font-cute text-yellow-300 mb-2">æ¯æ—¥ç™»å½•å¥–åŠ±</h3>
                    <p className="text-indigo-200 text-sm mb-6">æ¬¢è¿å›æ¥ï¼é€æ‚¨ä¸€ç¬”å¯åŠ¨èµ„é‡‘~</p>
                    <div className="text-3xl font-mono font-bold text-white mb-6">+${amount.toLocaleString()}</div>
                    <button onClick={onClose} className="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-xl text-white font-bold text-lg shadow-lg">å¼€å¿ƒæ”¶ä¸‹</button>
                </div>
            </div>
        );

        // --- æ¸¸æˆä¸»ä½“ ---
        const App = () => {
            const [balance, setBalance] = useState(10000);
            const [initialBalance, setInitialBalance] = useState(10000);
            const [bets, setBets] = useState({ small: 0, big: 0, triple: 0 });
            const [pointBets, setPointBets] = useState({});
            const [specialBets, setSpecialBets] = useState({}); 
            const [gameState, setGameState] = useState('idle');
            const [dice, setDice] = useState([1, 1, 1]);
            const [history, setHistory] = useState([]);
            const [selectedChip, setSelectedChip] = useState(100);
            const [nickname, setNickname] = useState('');
            const [winningZones, setWinningZones] = useState([]);
            const [winningPoints, setWinningPoints] = useState([]);
            const [winningSpecials, setWinningSpecials] = useState([]);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [betHistory, setBetHistory] = useState([]); 
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [resultText, setResultText] = useState(null); 
            const [showDailyBonus, setShowDailyBonus] = useState(false);
            const [showRelief, setShowRelief] = useState(false);
            
            // New Feed Logic State
            const [feedAnim, setFeedAnim] = useState(false);
            const [feedCount, setFeedCount] = useState(0);
            const [showSuperFeed, setShowSuperFeed] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appIdRef = useRef('default-app-id'); 

            useEffect(() => { 
                const savedName = localStorage.getItem('dice_game_nickname'); 
                if (savedName) setNickname(savedName); 
                
                // å°è¯•è¯»å–æœ¬åœ°å­˜å‚¨çš„ä»Šæ—¥åˆå§‹ä½™é¢
                const todayKey = `dice_start_${new Date().toDateString()}`;
                const savedStart = localStorage.getItem(todayKey);
                if (savedStart) setInitialBalance(parseInt(savedStart));
            }, []);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    const config = { apiKey: "AIzaSyCfoqSV5dI6-dzrvfx1e1NHnbpwlBTloKw", authDomain: "haer-870de.firebaseapp.com", projectId: "haer-870de", storageBucket: "haer-870de.firebasestorage.app", messagingSenderId: "397525543796", appId: "1:397525543796:web:c503e7ebb1586335615a21", measurementId: "G-08352H7R4G" };
                    if (config && config.apiKey) {
                        try {
                            let app; try { app = window.FB.initializeApp(config); } catch(e) { return; }
                            authRef.current = window.FB.getAuth(app); dbRef.current = window.FB.getFirestore(app);
                            await window.FB.signInAnonymously(authRef.current);
                            window.FB.onAuthStateChanged(authRef.current, (u) => { if (u) { setUser(u); setFirebaseReady(true); } });
                        } catch (e) { console.error("Firebase Init Error:", e); }
                    }
                };
                setTimeout(initFirebase, 100);
            }, []);

            useEffect(() => {
                // Ensure icons are rendered (fallback if lucide script runs early)
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            });

            useEffect(() => {
                if (!user || !dbRef.current) return;
                const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account');
                
                const unsubscribe = window.FB.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data(); 
                        if (data.balance !== undefined) {
                            setBalance(data.balance);
                            
                            // å¦‚æœè¿™æ˜¯æ–°çš„ä¸€å¤©ç¬¬ä¸€æ¬¡åŠ è½½æ•°æ®ï¼Œè®¾ç½®åˆå§‹ä½™é¢
                            const todayKey = `dice_start_${new Date().toDateString()}`;
                            if (!localStorage.getItem(todayKey)) {
                                setInitialBalance(data.balance);
                                localStorage.setItem(todayKey, data.balance.toString());
                            }
                        }
                        const totalBets = Object.values(pointBets).reduce((a,b)=>a+b,0) + bets.small + bets.big + bets.triple + Object.values(specialBets).reduce((a,b)=>a+b,0);
                        if (data.balance < 100 && gameState === 'idle' && totalBets === 0) { setTimeout(() => setShowRelief(true), 1000); }
                    } else { 
                        window.FB.setDoc(docRef, { balance: 10000, lastBonusDate: new Date().toDateString(), createdAt: window.FB.serverTimestamp() }, { merge: true }); 
                        setBalance(10000); 
                        setInitialBalance(10000);
                    }
                });

                const checkDailyBonus = async () => {
                    if (!dbRef.current) return;
                    try {
                        const bonusGiven = await window.FB.runTransaction(dbRef.current, async (transaction) => {
                            const sfDoc = await transaction.get(docRef);
                            if (!sfDoc.exists()) return false;
                            
                            const data = sfDoc.data();
                            const today = new Date().toDateString();
                            
                            if (data.lastBonusDate !== today) {
                                const newBalance = (data.balance || 0) + 10000;
                                transaction.update(docRef, { balance: newBalance, lastBonusDate: today });
                                
                                // æ›´æ–°ä»Šæ—¥åˆå§‹ä½™é¢ä¸ºå‘å®Œä½ä¿åçš„ä½™é¢
                                const todayKey = `dice_start_${today}`;
                                localStorage.setItem(todayKey, newBalance.toString());
                                return true; // Indicate bonus given
                            }
                            return false;
                        });
                        if (bonusGiven) { 
                            setShowDailyBonus(true); 
                            AudioSynth.playWin(); 
                            // é‡æ–°è¯»å–æœ€æ–°ä½™é¢ä½œä¸ºåˆå§‹ä½™é¢
                            const snap = await window.FB.getDoc(docRef);
                            if(snap.exists()) setInitialBalance(snap.data().balance);
                        }
                    } catch (e) { }
                };
                
                setTimeout(checkDailyBonus, 1000);
                return () => unsubscribe();
            }, [user]);

            // æ›´æ–°ä½™é¢å¹¶åŒæ­¥åˆ°å…¬å…±æ’è¡Œæ¦œ
            const updateCloudBalance = async (newBalance) => {
                if (!user || !dbRef.current) return;
                try { 
                    // 1. æ›´æ–°ç§æœ‰ä½™é¢
                    const docRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'account'); 
                    await window.FB.updateDoc(docRef, { balance: newBalance }); 
                    
                    // 2. æ›´æ–°å…¬å…±æˆ˜ç»©æ¦œ (å¸¦ profit)
                    const currentProfit = newBalance - initialBalance;
                    const leaderRef = window.FB.doc(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'leaderboard', user.uid);
                    await window.FB.setDoc(leaderRef, {
                        nickname: nickname || `User ${user.uid.slice(0,3)}`,
                        balance: newBalance,
                        profit: currentProfit,
                        updatedAt: window.FB.serverTimestamp()
                    }, { merge: true });

                } catch(e) { }
            };

            const handleRelief = () => { AudioSynth.playWin(); const newBalance = balance + 2000; setBalance(newBalance); updateCloudBalance(newBalance); setShowRelief(false); };

            const handleFeedMascot = () => {
                if (balance < 50) return;
                const newBalance = balance - 50;
                setBalance(newBalance);
                updateCloudBalance(newBalance);
                
                const newCount = feedCount + 1;
                setFeedCount(newCount);

                if (newCount >= 10) {
                    // Trigger Super Effect
                    setFeedCount(0);
                    setShowSuperFeed(true);
                    AudioSynth.playJackpot();
                    
                    // Broadcast
                    if (user && dbRef.current) {
                         try { window.FB.addDoc(window.FB.collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'chat_messages'), { text: `ğŸ”¥ ${nickname || 'è€æ¿'} è§¦å‘äº†çŒ«ç¥é™ä¸´ï¼å…¨åœºè†œæ‹œï¼`, senderId: 'SYSTEM', senderName: 'ç³»ç»Ÿ', isSystem: true, createdAt: window.FB.serverTimestamp() }); } catch(e) {}
                    }

                    setTimeout(() => setShowSuperFeed(false), 5000);
                } else {
                    AudioSynth.playKiss();
                    setFeedAnim(true);
                    setTimeout(() => setFeedAnim(false), 2000);
                    // Chance for chat msg
                    if (Math.random() > 0.8 && user && dbRef.current) {
                         try { window.FB.addDoc(window.FB.collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'chat_messages'), { text: `${nickname || 'è€æ¿'} ç»™çŒ«çŒ«å–‚äº†å°é±¼å¹²!`, senderId: 'SYSTEM', senderName: 'ç³»ç»Ÿ', isSystem: true, createdAt: window.FB.serverTimestamp() }); } catch(e) {}
                    }
                }
            };

            const addToBet = (category, key) => {
                if (gameState !== 'idle') return;
                if (balance < selectedChip) { AudioSynth.playLose(); return; }
                AudioSynth.playChip(); AudioSynth.vibrate(10);
                const newBalance = balance - selectedChip; setBalance(newBalance); updateCloudBalance(newBalance);
                setBetHistory(prev => [...prev, { category, key, amount: selectedChip }]);
                if (category === 'main') setBets(prev => ({ ...prev, [key]: prev[key] + selectedChip }));
                else if (category === 'point') setPointBets(prev => ({ ...prev, [key]: (prev[key] || 0) + selectedChip }));
                else if (category === 'special') setSpecialBets(prev => ({ ...prev, [key]: (prev[key] || 0) + selectedChip }));
            };

            const undoBet = () => {
                if (gameState !== 'idle' || betHistory.length === 0) return;
                const lastBet = betHistory[betHistory.length - 1];
                const newBalance = balance + lastBet.amount; setBalance(newBalance); updateCloudBalance(newBalance);
                if (lastBet.category === 'main') setBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                else if (lastBet.category === 'point') setPointBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                else if (lastBet.category === 'special') setSpecialBets(prev => ({ ...prev, [lastBet.key]: Math.max(0, prev[lastBet.key] - lastBet.amount) }));
                setBetHistory(prev => prev.slice(0, -1)); AudioSynth.playChip();
            };

            const rollDice = () => {
                if (betHistory.length === 0) { alert("è¯·å…ˆä¸‹æ³¨å–µï¼"); return; }
                setGameState('rolling'); setWinningZones([]); setFloatingTexts([]); setResultText(null);
                AudioSynth.playRoll(); AudioSynth.vibrate([50, 50, 50]);
                setTimeout(() => {
                    const d1 = Math.floor(Math.random() * 6) + 1; const d2 = Math.floor(Math.random() * 6) + 1; const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3; const isTriple = (d1 === d2 && d2 === d3);
                    let mainResult = !isTriple ? (total >= 11 ? 'big' : 'small') : 'triple';
                    setDice([d1, d2, d3]);
                    setTimeout(() => handleResult(d1, d2, d3, total, mainResult, isTriple), 600); 
                }, 1000); 
            };

            const handleResult = (d1, d2, d3, total, mainResult, isTriple) => {
                setGameState('revealed');
                let totalWin = 0; const winners = []; const newFloatingTexts = [];
                const diceStr = [d1, d2, d3].sort().join(''); 

                let resultStr = "";
                if (!isTriple && total >= 4 && total <= 10) { 
                    if (bets.small > 0) { const win = bets.small * 2; totalWin += win; newFloatingTexts.push({ id: 's', text: `+${win}`, x: '20%', y: '50%', color: '#ff6b6b' }); } 
                    winners.push('small'); resultStr = `${total}ç‚¹ å°`;
                }
                if (!isTriple && total >= 11 && total <= 17) { 
                    if (bets.big > 0) { const win = bets.big * 2; totalWin += win; newFloatingTexts.push({ id: 'b', text: `+${win}`, x: '80%', y: '50%', color: '#ff6b6b' }); } 
                    winners.push('big'); resultStr = `${total}ç‚¹ å¤§`;
                }
                if (isTriple) { 
                    if (bets.triple > 0) { const win = bets.triple * 25; totalWin += win; newFloatingTexts.push({ id: 't', text: `+${win}`, x: '50%', y: '40%' }); } 
                    winners.push('triple'); resultStr = `${total}ç‚¹ è±¹å­!`;
                }
                setResultText(resultStr);

                if (pointBets[total] > 0) { const win = pointBets[total] * 51; totalWin += win; winners.push(`p${total}`); newFloatingTexts.push({ id: 'p', text: `ğŸ¯ +${win}`, x: '50%', y: '30%', color: '#ec4899' }); }
                if (diceStr === '123' && specialBets.s123 > 0) { const win = specialBets.s123 * 501; totalWin += win; winners.push('s123'); newFloatingTexts.push({ id: 'sp1', text: `ğŸš€æš´å¯Œ +${win}`, x: '50%', y: '50%', color: 'red' }); AudioSynth.playJackpot(); }
                if (diceStr === '456' && specialBets.s456 > 0) { const win = specialBets.s456 * 501; totalWin += win; winners.push('s456'); newFloatingTexts.push({ id: 'sp2', text: `ğŸš€æš´å¯Œ +${win}`, x: '50%', y: '50%', color: 'red' }); AudioSynth.playJackpot(); }
                if (isTriple) { const key = `t${d1}`; if (specialBets[key] > 0) { const win = specialBets[key] * 501; totalWin += win; winners.push(key); newFloatingTexts.push({ id: 'sp3', text: `ğŸ”¥è±¹å­ç‹ +${win}`, x: '50%', y: '60%', color: 'red' }); AudioSynth.playJackpot(); } }

                if (totalWin > 10000 && firebaseReady && user) { window.FB.addDoc(window.FB.collection(dbRef.current, 'artifacts', appIdRef.current, 'public', 'data', 'chat_messages'), { text: `ğŸ‰ ${nickname || 'æœ‰äºº'} ç‹‚èµš ${totalWin}ï¼å¤ªå¼ºäº†ï¼`, senderId: 'SYSTEM', senderName: 'ç³»ç»Ÿ', isSystem: true, createdAt: window.FB.serverTimestamp() }); }

                setWinningZones(winners);

                if (totalWin > 0) {
                    const newBalance = balance + totalWin; setBalance(newBalance); updateCloudBalance(newBalance);
                    AudioSynth.playWin(); AudioSynth.vibrate([100, 50, 100]); setFloatingTexts(newFloatingTexts);
                } else { AudioSynth.playLose(); AudioSynth.vibrate(300); }

                setHistory(prev => [...prev, { result: mainResult, total, dice: [d1, d2, d3] }].slice(-10)); 
                setTimeout(() => { setGameState('idle'); setBets({ small: 0, big: 0, triple: 0 }); setPointBets({}); setSpecialBets({}); setBetHistory([]); setWinningZones([]); setFloatingTexts([]); setResultText(null); }, 3500);
            };

            const chips = [100, 500, 1000, 5000];
            const currentRank = getRankConfig(balance);

            return (
                <div className="theme-bg text-white flex flex-col h-full w-full relative">
                    <div className="absolute inset-0 theme-overlay pointer-events-none"></div>
                    <div className="absolute inset-0 pointer-events-none z-40">{floatingTexts.map(ft => <FloatingText key={ft.id} text={ft.text} x={ft.x} y={ft.y} color={ft.color} />)}</div>
                    {showSuperFeed && <SuperFeedEffect />}
                    
                    {firebaseReady && <ChatRoom user={user} db={dbRef.current} appId={appIdRef.current} nickname={nickname} setNickname={setNickname} balance={balance} />}
                    {showDailyBonus && <DailyBonusModal amount={10000} onClose={()=>setShowDailyBonus(false)} />}
                    {showRelief && <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur flex items-center justify-center p-6 animate-fade-in-up"><div className="bg-indigo-900 border-2 border-indigo-400 p-6 rounded-3xl text-center shadow-2xl w-full max-w-xs relative overflow-hidden"><div className="absolute inset-0 bg-indigo-500/10"></div><div className="relative z-10"><div className="text-5xl mb-2">ğŸ˜¿</div><h3 className="text-2xl font-cute text-indigo-200 mb-2">æ²¡é’±äº†...</h3><button onClick={handleRelief} className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold px-8 py-3 rounded-full shadow-lg animate-pulse-gold">é¢†å– $2,000 ç¿»æœ¬</button><button onClick={()=>setShowRelief(false)} className="block mt-4 text-xs text-white/40 underline w-full">å€”å¼ºç¦»å¼€</button></div></div></div>}

                    {/* Header */}
                    <div className="z-50 w-full max-w-4xl p-3 flex justify-between items-center relative flex-shrink-0">
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                            <div className="w-10 h-10 rounded-full overflow-hidden border-2 border-indigo-400 shadow-lg bg-slate-900 flex-shrink-0"><img src="1.jpg" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} /></div>
                            <div className="min-w-0 flex flex-col">
                                <h1 className="font-cute text-xl text-indigo-200 drop-shadow-sm truncate leading-none">å¤šå®éª°å­</h1>
                                <div className={`text-[10px] px-1.5 py-0.5 mt-1 rounded border w-fit ${currentRank.color}`}>{currentRank.title}</div>
                            </div>
                        </div>
                        <div className="glass-panel px-3 py-1 flex items-center gap-2 flex-shrink-0 ml-2 border-indigo-500/30">
                            {/* æ–°å¢: è·³è½¬åˆ° 21 ç‚¹æŒ‰é’® */}
                            <a href="blackjack.html" className="text-xs bg-indigo-500/20 px-2 py-1 rounded text-indigo-300 hover:text-white transition-colors mr-2">
                                â™ ï¸ ç©21ç‚¹
                            </a>
                            <span className="text-yellow-400 text-base">ğŸ’°</span>
                            <span className="text-lg font-mono font-bold text-white">{balance.toLocaleString()}</span>
                        </div>
                    </div>

                    {/* Scrollable Content */}
                    <div className="flex-1 overflow-y-auto w-full flex flex-col items-center pb-40 hide-scrollbar">
                        
                        {/* Game Area (Increased Top Margin) */}
                        <div className="relative w-full flex justify-center items-center mt-24 mb-4 flex-shrink-0">
                            <div className="game-container relative w-[85%] max-w-md h-36 flex justify-center items-center">
                                <MascotDealer gameState={gameState} onFeed={handleFeedMascot} feedAnim={feedAnim} feedCount={feedCount} showSuperFeed={showSuperFeed} />
                                <Die3D value={dice[0]} rolling={gameState === 'rolling'} isGolden={winningZones.includes('triple')} />
                                <Die3D value={dice[1]} rolling={gameState === 'rolling'} isGolden={winningZones.includes('triple')} />
                                <Die3D value={dice[2]} rolling={gameState === 'rolling'} isGolden={winningZones.includes('triple')} />
                            </div>
                        </div>
                        <div className="flex gap-1 h-5 opacity-70 mb-4">{history.map((h, i) => <div key={i} className={`w-5 h-5 rounded-full flex items-center justify-center text-[10px] text-white font-bold shadow-sm ${h.result==='big'?'bg-red-500':h.result==='small'?'bg-blue-500':'bg-green-500'}`}>{h.result==='big'?'å¤§':h.result==='small'?'å°':'è±¹'}</div>)}</div>

                        {/* Betting Area */}
                        <div className="w-full max-w-4xl px-3 flex flex-col gap-4">
                            
                            {/* Specific Triples (500x) */}
                            <div>
                                <div className="flex justify-between px-1 mb-1 text-[10px] text-indigo-300" style={{paddingTop: '8px'}}><span>ğŸ”¥ æš´å¯ŒåŒº (1èµ”500)</span><span>æ»‘åŠ¨ä¸‹æ³¨</span></div>
                                <div className="flex overflow-x-auto space-x-2 pb-2 hide-scrollbar px-1">
                                    <button
                                        disabled={gameState !== 'idle'}
                                        onClick={() => addToBet('special', 's123')}
                                        className={`flex-shrink-0 w-20 h-12 rounded-xl border bg-slate-800/60 border-indigo-500/40 flex flex-col items-center justify-center relative px-2 ${winningZones.includes('s123')?'animate-win':''}`}
                                    >
                                        <span className="font-bold text-xs leading-tight">123</span>
                                        <span className="text-[9px] text-indigo-200/80 mt-0.5">é¡ºå­</span>
                                        {specialBets.s123>0 && (
                                            <div className="absolute -bottom-2 -right-1 bg-yellow-400 text-black text-[7px] px-1.5 py-0.5 rounded-full shadow-sm">
                                                ${specialBets.s123}
                                            </div>
                                        )}
                                    </button>
                                    <button
                                        disabled={gameState !== 'idle'}
                                        onClick={() => addToBet('special', 's456')}
                                        className={`flex-shrink-0 w-20 h-12 rounded-xl border bg-slate-800/60 border-indigo-500/40 flex flex-col items-center justify-center relative px-2 ${winningZones.includes('s456')?'animate-win':''}`}
                                    >
                                        <span className="font-bold text-xs leading-tight">456</span>
                                        <span className="text-[9px] text-indigo-200/80 mt-0.5">é¡ºå­</span>
                                        {specialBets.s456>0 && (
                                            <div className="absolute -bottom-2 -right-1 bg-yellow-400 text-black text-[7px] px-1.5 py-0.5 rounded-full shadow-sm">
                                                ${specialBets.s456}
                                            </div>
                                        )}
                                    </button>
                                    {[1,2,3,4,5,6].map(n => (
                                        <button
                                            key={n}
                                            disabled={gameState !== 'idle'}
                                            onClick={() => addToBet('special', `t${n}`)}
                                            className={`flex-shrink-0 w-16 h-12 rounded-xl border bg-slate-800/60 border-indigo-500/40 flex flex-col items-center justify-center relative px-1 ${winningZones.includes(`t${n}`)?'animate-win':''}`}
                                        >
                                            <span className="font-bold text-xs leading-tight">{n}{n}{n}</span>
                                            <span className="text-[9px] text-indigo-200/80 mt-0.5">è±¹å­</span>
                                            {specialBets[`t${n}`]>0 && (
                                                <div className="absolute -bottom-2 -right-1 bg-yellow-400 text-black text-[7px] px-1.5 py-0.5 rounded-full shadow-sm">
                                                    ${specialBets[`t${n}`]}
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Point Bets (50x) */}
                            <div>
                                <div className="flex justify-between px-1 mb-1 text-[10px] text-indigo-300" style={{paddingTop: '8px'}}><span>ğŸ¯ çŒœç‚¹æ•° (1èµ”50)</span><span>æ»‘åŠ¨ä¸‹æ³¨</span></div>
                                <div className="flex overflow-x-auto space-x-2 pb-2 hide-scrollbar px-1">
                                    {Array.from({length: 14}, (_, i) => i + 4).map(num => (
                                        <button key={num} disabled={gameState !== 'idle'} onClick={() => addToBet('point', num)} className={`flex-shrink-0 w-12 h-14 rounded-2xl border-b-4 transition-all active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative ${pointBets[num] > 0 ? 'bg-purple-600 border-purple-800 text-white' : 'bg-slate-800/50 border-white/10 text-indigo-200 hover:bg-white/5'} ${winningZones.includes(`p${num}`) ? 'animate-win' : ''}`}>
                                            <span className="font-cute text-xl">{num}</span>
                                            {pointBets[num] > 0 && <span className="text-[8px] bg-black/40 px-1 rounded-full absolute bottom-1">${pointBets[num]}</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Main Bets */}
                            <div className="flex gap-3 h-24 mb-2">
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'small')} className={`flex-1 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.small>0?'bg-blue-600 border-blue-800':'bg-slate-800/60 border-indigo-900/60'} ${winningZones.includes('small')?'animate-win':''}`}>
                                    <span className="font-cute text-4xl text-white drop-shadow-md">å°</span><span className="text-[10px] text-white/50">4-10</span>{bets.small>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.small}</div>}
                                </button>
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'triple')} className={`w-20 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.triple>0?'bg-green-600 border-green-800':'bg-slate-800/60 border-indigo-900/60'} ${winningZones.includes('triple')?'animate-win':''}`}>
                                    <span className="font-cute text-xl text-white drop-shadow-md">è±¹å­</span><span className="text-[10px] text-white/50">1:24</span>{bets.triple>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.triple}</div>}
                                </button>
                                <button disabled={gameState !== 'idle'} onClick={() => addToBet('main', 'big')} className={`flex-1 rounded-3xl border-b-4 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center relative shadow-lg transition-colors ${bets.big>0?'bg-red-600 border-red-800':'bg-slate-800/60 border-indigo-900/60'} ${winningZones.includes('big')?'animate-win':''}`}>
                                    <span className="font-cute text-4xl text-white drop-shadow-md">å¤§</span><span className="text-[10px] text-white/50">11-17</span>{bets.big>0 && <div className="absolute -top-2 bg-yellow-400 text-black text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">${bets.big}</div>}
                                </button>
                            </div>
                        </div>

                        {/* Stats Section */}
                        <StatsBoard db={dbRef.current} appId={appIdRef.current} />
                    </div>

                    {/* Fixed Footer Controls */}
                    <div className="absolute bottom-0 left-0 w-full p-3 bg-slate-900/95 border-t border-indigo-500/20 backdrop-blur-md z-50">
                        <div className="w-full max-w-4xl mx-auto flex justify-between items-center gap-3">
                            <button onClick={undoBet} disabled={gameState !== 'idle' || betHistory.length === 0} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 text-white/70 disabled:opacity-30 active:bg-white/20">
                                <lucide-icon name="rotate-ccw" size="18"></lucide-icon>
                            </button>
                            <div className="flex gap-2 flex-1 overflow-x-auto hide-scrollbar px-1">
                                {chips.map(val => <button key={val} onClick={() => setSelectedChip(val)} className={`flex-shrink-0 w-10 h-10 rounded-full border-2 border-dashed flex items-center justify-center font-bold text-[10px] transition-transform active:scale-90 ${selectedChip===val?'border-yellow-400 bg-yellow-500 text-black shadow-lg':'border-white/20 text-white/50'}`}>{val}</button>)}
                            </div>
                            <button onClick={rollDice} disabled={gameState === 'rolling' || betHistory.length === 0} className={`flex-1 py-2.5 rounded-xl font-cute text-xl tracking-widest shadow-lg active:scale-95 transition-all ${gameState==='rolling'?'bg-slate-600 text-white/50 cursor-not-allowed':'bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-indigo-500/50'}`}>
                                {gameState === 'rolling' ? '...' : 'å¼€ æ‘‡'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>