<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå®éª°å­ (Duo Bao Dice)</title>
    
    <!-- å¼•å…¥ React å’Œ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- é¢„è®¾å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* å…¨å±€æ ·å¼è°ƒæ•´ */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0a1128; /* æ·±è‰²èƒŒæ™¯å…œåº• */
            overflow: hidden;
            touch-action: manipulation; /* ç¦æ­¢åŒå‡»ç¼©æ”¾ */
            user-select: none;
        }
        
        /* ä½¿ç”¨å¿«ä¹å­—ä½“ä½œä¸ºæ ‡é¢˜ */
        .font-cute { font-family: 'Zcool KuaiLe', sans-serif; }

        /* --- 3D éª°å­æ ¸å¿ƒå¼•æ“ --- */
        .scene {
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cube-wrapper {
            position: relative;
            transform-style: preserve-3d;
            width: 80px;
            height: 80px;
            transition: transform 1.2s cubic-bezier(0.19, 1, 0.22, 1), top 0.5s ease-in-out, left 0.5s ease-in-out; 
        }

        .cube {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
        }

        .face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 16px; /* æ›´åœ†æ¶¦çš„éª°å­ */
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1), inset 0 0 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            backface-visibility: hidden; /* ä¼˜åŒ–æ€§èƒ½ */
        }

        /* éª°å­ç‚¹æ•° */
        .dot {
            width: 16px;
            height: 16px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5);
        }
        .dot.red {
            background: #ff5e5e;
            box-shadow: inset 1px 1px 3px rgba(100,0,0,0.3);
        }

        /* 3Dæ„å»º */
        .face.front  { transform: rotateY(0deg) translateZ(40px); }
        .face.back   { transform: rotateY(180deg) translateZ(40px); }
        .face.right  { transform: rotateY(90deg) translateZ(40px); }
        .face.left   { transform: rotateY(-90deg) translateZ(40px); }
        .face.top    { transform: rotateX(90deg) translateZ(40px); }
        .face.bottom { transform: rotateX(-90deg) translateZ(40px); }

        /* åŠ¨æ€é˜´å½± */
        .shadow-spot {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(rgba(0,0,0,0.4), transparent 70%);
            transform: rotateX(90deg) translateZ(-65px);
            filter: blur(12px);
            opacity: 0.6;
            transition: all 0.3s;
        }

        /* è¾“èµ¢åŠ¨ç”» */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .animate-pulse-gold {
            animation: pulse-gold 1.5s infinite;
        }
        
        @keyframes flash-win {
            0%, 100% { background-color: rgba(234, 179, 8, 0.2); border-color: rgba(234, 179, 8, 1); }
            50% { background-color: rgba(234, 179, 8, 0.6); border-color: #fff; box-shadow: 0 0 30px #fbbf24; }
        }
        .animate-win {
            animation: flash-win 0.8s infinite;
        }

        /* å°æ¸¸æˆé£æ ¼èƒŒæ™¯ */
        .game-bg {
            background-color: #1a1c2c; /* æ·±è“ç´«è‰²è°ƒ */
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
        }
        
        .game-overlay {
            background: radial-gradient(circle at center, rgba(26, 28, 44, 0.3) 0%, rgba(10, 12, 20, 0.8) 100%);
        }

        /* ç»ç’ƒæ‹Ÿæ€ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            border-radius: 20px;
        }

        /* èŠå¤©å®¤æ»šåŠ¨æ¡æ ·å¼ */
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }
    </style>

    <!-- Firebase Setup Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp
        };
    </script>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- éŸ³é¢‘åˆæˆå™¨ ---
        const AudioSynth = {
            ctx: null,
            init: () => {
                if (!AudioSynth.ctx) AudioSynth.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: (freq, type, duration) => {
                AudioSynth.init();
                const osc = AudioSynth.ctx.createOscillator();
                const gain = AudioSynth.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(AudioSynth.ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, AudioSynth.ctx.currentTime + duration);
                osc.stop(AudioSynth.ctx.currentTime + duration);
            },
            playRoll: () => {
                // æ¸…è„†çš„ç¢°æ’å£°
                for(let i=0; i<6; i++) {
                    setTimeout(() => AudioSynth.playTone(1200 + Math.random()*800, 'sine', 0.05), i * 60);
                }
            },
            playWin: () => {
                // å¯çˆ±çš„èƒœåˆ©éŸ³æ•ˆ
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => AudioSynth.playTone(f, 'sine', 0.4), i * 100));
            },
            playLose: () => {
                AudioSynth.playTone(200, 'triangle', 0.3);
            },
            playChip: () => {
                 AudioSynth.playTone(1500, 'sine', 0.08);
            },
            playMsg: () => {
                AudioSynth.playTone(800, 'sine', 0.1);
            }
        };

        // --- ç²’å­æ•ˆæœ ---
        const ParticleSystem = ({ active }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                const particles = [];
                const colors = ['#FCD34D', '#F59E0B', '#FFFFFF', '#60A5FA']; // é‡‘ã€æ©™ã€ç™½ã€è“

                for(let i=0; i<80; i++) {
                    particles.push({
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 20,
                        vy: (Math.random() - 0.5) * 20,
                        size: Math.random() * 6 + 4,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        life: 1.0,
                        shape: Math.random() > 0.5 ? 'circle' : 'rect'
                    });
                }

                const animate = () => {
                    if (!canvas) return;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = false;
                    particles.forEach(p => {
                        if(p.life > 0) {
                            alive = true;
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vy += 0.3; // é‡åŠ›
                            p.vx *= 0.95; // é˜»åŠ›
                            p.life -= 0.015;
                            ctx.globalAlpha = p.life;
                            ctx.fillStyle = p.color;
                            ctx.beginPath();
                            if (p.shape === 'circle') {
                                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            } else {
                                ctx.rect(p.x, p.y, p.size, p.size);
                            }
                            ctx.fill();
                        }
                    });
                    if (alive) requestAnimationFrame(animate);
                    else ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                animate();

            }, [active]);

            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-50" />;
        };

        // --- èŠå¤©ç»„ä»¶ ---
        const ChatRoom = ({ user, db, appId, nickname, setNickname }) => {
            const [messages, setMessages] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const [inputText, setInputText] = useState("");
            const [tempName, setTempName] = useState(nickname);
            const [isEditingName, setIsEditingName] = useState(!nickname);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!user || !db) return;

                const q = window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                
                const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach((doc) => {
                        msgs.push({ id: doc.id, ...doc.data() });
                    });
                    msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setMessages(msgs.slice(-50));
                }, (error) => {
                    console.error("Chat listener error:", error);
                });

                return () => unsubscribe();
            }, [user, db, appId]);

            useEffect(() => {
                if (isOpen) {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages, isOpen]);

            const saveNickname = () => {
                if(tempName.trim()) {
                    setNickname(tempName.trim());
                    setIsEditingName(false);
                    localStorage.setItem('dice_game_nickname', tempName.trim());
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputText.trim() || !user) return;

                const text = inputText.trim();
                setInputText("");

                try {
                    await window.FB.addDoc(window.FB.collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), {
                        text: text,
                        senderId: user.uid.slice(0, 5),
                        senderName: nickname || `User ${user.uid.slice(0,3)}`,
                        isSystem: false,
                        createdAt: window.FB.serverTimestamp()
                    });
                } catch (err) {
                    console.error("Send failed", err);
                }
            };

            return (
                <div className={`fixed bottom-4 right-4 z-50 flex flex-col items-end transition-all duration-300 ${isOpen ? 'translate-y-0' : 'translate-y-0'}`}>
                    
                    {isOpen && (
                        <div className="mb-3 w-80 h-96 glass-panel flex flex-col overflow-hidden border-0 shadow-2xl animate-fade-in-up bg-slate-900/90">
                            {/* Header */}
                            <div className="bg-indigo-600/80 p-3 flex justify-between items-center">
                                <span className="text-white font-bold text-sm flex items-center gap-2">
                                    <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                    æ‘¸é±¼èŠå¤©å®¤
                                </span>
                                <button onClick={() => setIsOpen(false)} className="text-white/70 hover:text-white">
                                    âœ•
                                </button>
                            </div>

                            {/* Name Setup */}
                            {isEditingName ? (
                                <div className="absolute inset-0 z-20 bg-slate-900/95 flex flex-col items-center justify-center p-6">
                                    <h3 className="text-yellow-400 font-bold mb-4">èµ·ä¸ªå¥½å¬çš„åå­—</h3>
                                    <input 
                                        type="text" 
                                        value={tempName}
                                        onChange={(e) => setTempName(e.target.value)}
                                        placeholder="ä¾‹å¦‚: èµŒç¥é˜¿å¼º"
                                        className="w-full bg-white/10 border border-indigo-500 rounded-xl px-4 py-2 text-white mb-4 text-center focus:outline-none"
                                    />
                                    <button onClick={saveNickname} className="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">
                                        å¼€å§‹èŠå¤©
                                    </button>
                                </div>
                            ) : (
                                <div className="bg-indigo-900/30 px-3 py-2 text-[10px] text-indigo-200 flex justify-between cursor-pointer hover:bg-indigo-900/50 border-b border-white/5" onClick={() => setIsEditingName(true)}>
                                    <span>å½“å‰: {nickname}</span>
                                    <span>(ç‚¹æˆ‘æ”¹å)</span>
                                </div>
                            )}

                            {/* Messages */}
                            <div className="flex-1 overflow-y-auto p-3 space-y-3 chat-scroll">
                                {messages.length === 0 && (
                                    <div className="text-center text-white/30 text-xs mt-10">å¿«æ¥å‘ç¬¬ä¸€æ¡æ¶ˆæ¯!</div>
                                )}
                                {messages.map((msg) => {
                                    const isMe = msg.senderId === user?.uid.slice(0, 5);
                                    return (
                                        <div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                            <span className="text-[10px] text-white/40 mb-1 px-1">
                                                {msg.senderName}
                                            </span>
                                            <div className={`max-w-[85%] px-3 py-2 rounded-2xl text-sm break-words shadow-sm ${
                                                isMe 
                                                ? 'bg-indigo-500 text-white rounded-tr-none' 
                                                : 'bg-slate-700 text-gray-200 rounded-tl-none'
                                            }`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Input */}
                            <form onSubmit={sendMessage} className="p-2 bg-slate-800/50 border-t border-white/5 flex gap-2">
                                <input 
                                    type="text" 
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
                                    disabled={isEditingName}
                                    className="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-4 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 disabled:opacity-50"
                                />
                                <button type="submit" disabled={isEditingName} className="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full transition-colors disabled:opacity-50 shadow-lg">
                                    <lucide-icon name="send" size="16"></lucide-icon>
                                </button>
                            </form>
                        </div>
                    )}

                    {/* æ‚¬æµ®æŒ‰é’® */}
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-14 h-14 rounded-full bg-indigo-500 hover:bg-indigo-600 text-white flex items-center justify-center hover:scale-110 transition-transform shadow-lg group border-2 border-white/20"
                    >
                        {isOpen ? (
                            <span className="text-xl font-bold">âœ•</span>
                        ) : (
                            <lucide-icon name="message-circle" size="24"></lucide-icon>
                        )}
                        {!isOpen && (
                            <span className="absolute top-0 right-0 w-3.5 h-3.5 bg-red-500 rounded-full border-2 border-indigo-900 animate-bounce"></span>
                        )}
                    </button>
                </div>
            );
        };

        // --- å•ä¸ª3Déª°å­ç»„ä»¶ ---
        const Die3D = ({ value, rolling }) => {
            const [transform, setTransform] = useState('');
            
            useEffect(() => {
                if (rolling) {
                    const x = Math.random() * 1440 - 720; 
                    const y = Math.random() * 1440 - 720;
                    setTransform(`rotateX(${x}deg) rotateY(${y}deg)`);
                } else {
                    let rX = 0, rY = 0;
                    switch(value) {
                        case 1: rX = 0; rY = 0; break;
                        case 2: rX = 0; rY = 180; break; 
                        case 3: rX = 0; rY = -90; break;
                        case 4: rX = 0; rY = 90; break;
                        case 5: rX = -90; rY = 0; break;
                        case 6: rX = 90; rY = 0; break;
                    }
                    // å¢åŠ æ›´å¤šæ—‹è½¬åœˆæ•°ï¼Œè®©å®ƒåœä¸‹æ¥æ›´å¹³æ»‘
                    setTransform(`rotateX(${rX + 1440}deg) rotateY(${rY + 1440}deg)`); 
                }
            }, [value, rolling]);

            const Face = ({ dots, className }) => (
                <div className={`face ${className}`}>
                    <div className="relative w-full h-full grid grid-cols-3 grid-rows-3 p-1.5">
                        {dots.map((pos, i) => (
                            <div key={i} className={`dot ${pos.val === 'center' ? 'red' : ''}`} 
                                 style={{ 
                                     gridColumn: pos.col, 
                                     gridRow: pos.row,
                                     alignSelf: 'center',
                                     justifySelf: 'center'
                                 }} 
                            />
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="scene mx-2 sm:mx-4 scale-75 sm:scale-100">
                    <div className="cube-wrapper" style={{ transform: transform }}>
                        <div className="cube">
                            <Face className="front" dots={[{col:2,row:2,val:'center'}]} /> 
                            <Face className="back" dots={[{col:1,row:1},{col:3,row:3}]} /> 
                            <Face className="right" dots={[{col:1,row:1},{col:2,row:2},{col:3,row:3}]} /> 
                            <Face className="left" dots={[{col:1,row:1},{col:1,row:3},{col:3,row:1},{col:3,row:3}]} /> 
                            <Face className="top" dots={[{col:1,row:1},{col:3,row:1},{col:2,row:2},{col:1,row:3},{col:3,row:3}]} /> 
                            <Face className="bottom" dots={[{col:1,row:1},{col:1,row:2},{col:1,row:3},{col:3,row:1},{col:3,row:2},{col:3,row:3}]} /> 
                        </div>
                        <div className={`shadow-spot ${rolling ? 'scale-50' : 'scale-100'}`}></div>
                    </div>
                </div>
            );
        };

        // --- è·¯å•å°åœ†ç‚¹ ---
        const RoadMapDot = ({ result }) => {
            let color = 'bg-gray-500';
            let text = '?';
            if (result === 'big') { color = 'bg-red-500'; text = 'å¤§'; }
            if (result === 'small') { color = 'bg-blue-500'; text = 'å°'; }
            if (result === 'triple') { color = 'bg-green-500'; text = 'å›´'; }
            
            return (
                <div className={`w-6 h-6 rounded-full ${color} flex items-center justify-center text-[10px] text-white font-bold shadow-sm mb-1 border border-white/10`}>
                    {text}
                </div>
            );
        };

        // --- ä¸»ç¨‹åº ---
        const App = () => {
            const [balance, setBalance] = useState(10000);
            const [bets, setBets] = useState({ small: 0, big: 0, triple: 0 });
            const [gameState, setGameState] = useState('idle');
            const [dice, setDice] = useState([1, 1, 1]);
            const [history, setHistory] = useState([]);
            const [showParticles, setShowParticles] = useState(false);
            const [selectedChip, setSelectedChip] = useState(100);
            const [nickname, setNickname] = useState('');
            const [winningZones, setWinningZones] = useState([]);
            
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            
            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appIdRef = useRef('default-app-id'); 

            useEffect(() => {
                const savedBalance = localStorage.getItem('dice_game_balance');
                if (savedBalance) setBalance(parseInt(savedBalance));
                
                const savedName = localStorage.getItem('dice_game_nickname');
                if (savedName) setNickname(savedName);
            }, []);

            useEffect(() => {
                localStorage.setItem('dice_game_balance', balance.toString());
            }, [balance]);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;

                    // --- é…ç½®åŒºåŸŸ ---
                    const config = {
                        apiKey: "AIzaSyCfoqSV5dI6-dzrvfx1e1NHnbpwlBTloKw",
                        authDomain: "haer-870de.firebaseapp.com",
                        projectId: "haer-870de",
                        storageBucket: "haer-870de.firebasestorage.app",
                        messagingSenderId: "397525543796",
                        appId: "1:397525543796:web:c503e7ebb1586335615a21",
                        measurementId: "G-08352H7R4G"
                    };
                    // ----------------

                    if (config && config.apiKey) {
                        try {
                            let app;
                            try {
                                app = window.FB.initializeApp(config);
                            } catch(e) {
                                console.log("App init skip");
                                return;
                            }

                            authRef.current = window.FB.getAuth(app);
                            dbRef.current = window.FB.getFirestore(app);

                            await window.FB.signInAnonymously(authRef.current);

                            window.FB.onAuthStateChanged(authRef.current, (u) => {
                                if (u) {
                                    setUser(u);
                                    setFirebaseReady(true);
                                }
                            });
                        } catch (e) {
                            console.error("Firebase Init Error:", e);
                        }
                    }
                };
                
                setTimeout(initFirebase, 100);
            }, []);


            const placeBet = (type) => {
                if (gameState !== 'idle') return;
                if (balance < selectedChip) {
                    alert("ä½™é¢ä¸è¶³å•¦ï¼å»èµ¢ç‚¹å›æ¥ï¼");
                    return;
                }
                AudioSynth.playChip();
                setBalance(prev => prev - selectedChip);
                setBets(prev => ({
                    ...prev,
                    [type]: prev[type] + selectedChip
                }));
            };

            const rollDice = () => {
                if (bets.small === 0 && bets.big === 0 && bets.triple === 0) {
                    alert("è¯·å…ˆä¸‹æ³¨å“¦ï¼");
                    return;
                }
                
                setGameState('rolling');
                setWinningZones([]); 
                AudioSynth.playRoll();
                
                setTimeout(() => {
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3;
                    const isTriple = (d1 === d2 && d2 === d3);
                    
                    let mainResult = 'triple';
                    if (!isTriple) {
                        mainResult = (total >= 11 && total <= 17) ? 'big' : 'small';
                    }

                    setDice([d1, d2, d3]);
                    
                    setTimeout(() => {
                        handleResult(d1, d2, d3, total, mainResult, isTriple);
                    }, 1200); 
                    
                }, 1500); 
            };

            const handleResult = (d1, d2, d3, total, mainResult, isTriple) => {
                setGameState('revealed');
                
                let totalWin = 0;
                const winners = [];

                if (!isTriple && total >= 4 && total <= 10) {
                    if (bets.small > 0) totalWin += bets.small * 2;
                    winners.push('small');
                }

                if (!isTriple && total >= 11 && total <= 17) {
                    if (bets.big > 0) totalWin += bets.big * 2;
                    winners.push('big');
                }

                if (isTriple) {
                    if (bets.triple > 0) totalWin += bets.triple * 25;
                    winners.push('triple');
                }

                setWinningZones(winners);

                if (totalWin > 0) {
                    setBalance(prev => prev + totalWin);
                    AudioSynth.playWin();
                    setShowParticles(true);
                    setTimeout(() => setShowParticles(false), 3000);
                } else {
                    AudioSynth.playLose();
                }

                setHistory(prev => [...prev, { result: mainResult, total, dice: [d1, d2, d3] }].slice(-20)); 

                setTimeout(() => {
                    setGameState('idle');
                    setBets({ small: 0, big: 0, triple: 0 });
                    setWinningZones([]);
                }, 3500);
            };

            const chips = [100, 500, 1000];
            const totalBetAmount = bets.small + bets.big + bets.triple;

            return (
                <div className="relative w-full h-screen flex flex-col items-center justify-between pb-6 game-bg overflow-hidden text-white">
                    <div className="absolute inset-0 game-overlay pointer-events-none"></div>
                    <ParticleSystem active={showParticles} />
                    
                    {firebaseReady && (
                        <ChatRoom user={user} db={dbRef.current} appId={appIdRef.current} nickname={nickname} setNickname={setNickname} />
                    )}

                    {/* Header */}
                    <div className="z-10 w-full max-w-4xl p-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            {/* çŒ«çŒ«å¤´åƒ (è¿™é‡Œä½¿ç”¨ä¸€ä¸ªåœ†å½¢çš„divæ¨¡æ‹Ÿï¼Œæ‚¨æ›¿æ¢srcå³å¯) */}
                            <div className="w-14 h-14 rounded-full overflow-hidden border-2 border-white/20 shadow-lg bg-white">
                                <img src="1.jpg" alt="Avatar" className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://cdn-icons-png.flaticon.com/512/616/616430.png'}} />
                            </div>
                            <div>
                                <h1 className="font-cute text-3xl text-yellow-300 tracking-wider drop-shadow-lg">å¤šå®éª°å­</h1>
                                <p className="text-indigo-200 text-xs flex gap-2">
                                    {nickname ? `ä½ å¥½å‘€, ${nickname}` : 'æ¬¢è¿å…‰ä¸´~'}
                                </p>
                            </div>
                        </div>
                        
                        <div className="glass-panel px-4 py-2 flex items-center gap-2">
                            <span className="text-yellow-400 text-xl">ğŸ’°</span>
                            <span className="text-2xl font-mono font-bold text-white">
                                {balance.toLocaleString()}
                            </span>
                        </div>
                    </div>

                    {/* æ¸¸æˆä¸»åŒºåŸŸ */}
                    <div className="z-10 flex-1 flex flex-col justify-center items-center w-full">
                        {/* éª°ç›…åŒºåŸŸ */}
                        <div className="relative w-[90%] max-w-lg h-48 sm:h-64 flex justify-center items-center bg-slate-900/40 rounded-[3rem] border border-white/10 shadow-2xl backdrop-blur-sm">
                            {/* æç¤ºæ–‡å­— */}
                            {gameState === 'revealed' && (
                                <div className="absolute -top-16 animate-bounce z-20 w-full text-center">
                                    <span className={`font-cute text-4xl drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] ${
                                        winningZones.includes('big') ? 'text-red-400' : (winningZones.includes('small') ? 'text-blue-400' : 'text-green-400')
                                    }`}>
                                        {dice.reduce((a,b)=>a+b,0)}ç‚¹! 
                                        {winningZones.includes('triple') ? ' è±¹å­!' : (winningZones.includes('big') ? ' å¤§!' : ' å°!')}
                                    </span>
                                </div>
                            )}

                            <Die3D value={dice[0]} rolling={gameState === 'rolling'} />
                            <Die3D value={dice[1]} rolling={gameState === 'rolling'} />
                            <Die3D value={dice[2]} rolling={gameState === 'rolling'} />
                        </div>
                        
                        {/* ç ç›˜è·¯ (å†å²è®°å½•) */}
                        <div className="mt-6 h-8 flex gap-1.5 items-end opacity-90">
                            {history.map((h, idx) => (
                                <RoadMapDot key={idx} result={h.result} />
                            ))}
                        </div>
                    </div>

                    {/* åº•éƒ¨æ“ä½œåŒº */}
                    <div className="z-20 w-full max-w-4xl px-4 mb-2 sm:mb-0">
                        {/* ä¸‹æ³¨åŒº */}
                        <div className="flex gap-3 sm:gap-5 mb-5 h-36 sm:h-44">
                            
                            {/* æŠ¼å° */}
                            <button 
                                disabled={gameState !== 'idle'}
                                onClick={() => placeBet('small')}
                                className={`
                                    flex-1 relative group rounded-3xl border-b-8 transition-all duration-150 active:border-b-0 active:translate-y-2
                                    flex flex-col items-center justify-center gap-1 shadow-xl
                                    ${winningZones.includes('small') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''}
                                    ${bets.small > 0 ? 'bg-blue-500 border-blue-700' : 'bg-slate-700 border-slate-800 hover:bg-slate-600'}
                                `}
                            >
                                <span className="font-cute text-5xl sm:text-7xl text-white drop-shadow-md">å°</span>
                                <span className="text-white/60 text-xs font-bold">4-10</span>
                                {bets.small > 0 && (
                                    <div className="absolute -top-3 bg-yellow-400 text-black font-bold px-3 py-1 rounded-full shadow-md text-xs">
                                        ${bets.small}
                                    </div>
                                )}
                            </button>

                            {/* æŠ¼è±¹å­ (å…¨å›´) */}
                            <button 
                                disabled={gameState !== 'idle'}
                                onClick={() => placeBet('triple')}
                                className={`
                                    w-24 sm:w-36 relative group rounded-3xl border-b-8 transition-all duration-150 active:border-b-0 active:translate-y-2
                                    flex flex-col items-center justify-center gap-1 shadow-xl
                                    ${winningZones.includes('triple') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''}
                                    ${bets.triple > 0 ? 'bg-green-500 border-green-700' : 'bg-slate-700 border-slate-800 hover:bg-slate-600'}
                                `}
                            >
                                <div className="text-center leading-tight">
                                    <span className="font-cute text-2xl sm:text-4xl text-white drop-shadow-md block">è±¹å­</span>
                                    <span className="text-[10px] text-white/60 font-bold block">1èµ”24</span>
                                </div>
                                {bets.triple > 0 && (
                                    <div className="absolute -top-3 bg-yellow-400 text-black font-bold px-2 py-1 rounded-full shadow-md text-xs">
                                        ${bets.triple}
                                    </div>
                                )}
                            </button>

                            {/* æŠ¼å¤§ */}
                            <button 
                                disabled={gameState !== 'idle'}
                                onClick={() => placeBet('big')}
                                className={`
                                    flex-1 relative group rounded-3xl border-b-8 transition-all duration-150 active:border-b-0 active:translate-y-2
                                    flex flex-col items-center justify-center gap-1 shadow-xl
                                    ${winningZones.includes('big') ? 'animate-win z-30 ring-4 ring-yellow-400' : ''}
                                    ${bets.big > 0 ? 'bg-red-500 border-red-700' : 'bg-slate-700 border-slate-800 hover:bg-slate-600'}
                                `}
                            >
                                <span className="font-cute text-5xl sm:text-7xl text-white drop-shadow-md">å¤§</span>
                                <span className="text-white/60 text-xs font-bold">11-17</span>
                                {bets.big > 0 && (
                                    <div className="absolute -top-3 bg-yellow-400 text-black font-bold px-3 py-1 rounded-full shadow-md text-xs">
                                        ${bets.big}
                                    </div>
                                )}
                            </button>
                        </div>

                        {/* åº•éƒ¨æ§åˆ¶æ¡ */}
                        <div className="glass-panel rounded-2xl p-2 sm:p-3 flex justify-between items-center gap-4">
                            {/* ç­¹ç  */}
                            <div className="flex gap-2 sm:gap-3 pl-2">
                                {chips.map(val => (
                                    <button 
                                        key={val}
                                        onClick={() => setSelectedChip(val)}
                                        className={`
                                            w-12 h-12 sm:w-14 sm:h-14 rounded-full border-4 border-dashed flex items-center justify-center
                                            font-bold text-xs sm:text-sm shadow-md transition-transform active:scale-90
                                            ${selectedChip === val ? 'border-yellow-400 bg-yellow-500 text-black -translate-y-2' : 'border-slate-500 bg-slate-700 text-slate-300 hover:border-slate-400'}
                                        `}
                                    >
                                        {val}
                                    </button>
                                ))}
                            </div>

                            {/* å¼€å§‹æŒ‰é’® */}
                            <button 
                                onClick={rollDice}
                                disabled={gameState === 'rolling' || totalBetAmount === 0}
                                className={`
                                    flex-1 py-3 sm:py-4 rounded-xl font-cute text-2xl tracking-widest shadow-lg transition-all active:scale-95
                                    ${gameState === 'rolling' 
                                        ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                        : (totalBetAmount > 0 ? 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover:shadow-yellow-500/50 animate-pulse-gold' : 'bg-slate-600 text-slate-400')}
                                `}
                            >
                                {gameState === 'rolling' ? 'å¥½è¿æ¥...' : 'å¼€ æ‘‡ !'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>